<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=zh-CN lang=zh-cn><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>性能优化总览 &#183; Vee's space</title><meta name=description content><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/print.css media=print><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/poole.css><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/syntax.css><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><link href=https://vee-zhang.github.io/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%80%BB%E8%A7%88/index.md rel=alternate type=text/plain title="Vee's space"></head><body><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://vee-zhang.github.io><h1>Vee's space</h1></a><p class=lead>关于 DoIt 主题</p></div><nav><ul class=sidebar-nav><li><a href=https://vee-zhang.github.io>Home</a></li><li><a href=/posts/>所有文章</a></li><li><a href=/tags/>标签</a></li><li><a href=/categories/>分类</a></li><li><a href=/series/>系列</a></li><li><a href=/about/>关于</a></li></ul></nav><p>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</p></div></aside><main class="content container"><div class=post><h1>性能优化总览</h1><time datetime=2022-04-19T16:56:16+0800 class=post-date>Tue, Apr 19, 2022</time><h2 id=电量优化>电量优化</h2><ul><li>优化代码，减少不必要的操作，或者合并操作，减少设备活跃时间，比如一次性的请求网络数据，一次性的IO。</li><li>延迟操作，通过监听系统广播、WorkManager等方式监听设备充满电之后再搞事情。</li></ul><h2 id=网络优化>网络优化</h2><ul><li>直接使用IP地址，避免漫长的DNS解析过程</li><li>连接复用，避免多次建立连接（okHttp自带的keep-alive和多路复用）</li><li>对数据压缩处理（gzip）</li><li>采用json，protobuf，甚至graphQL减少数据体积和传输频次</li><li>本地缓存数据，避免频繁请求接口</li><li>识别设备网络状态，在2/3/4G流量状态下传输低清图片</li><li>使用webP格式图片</li></ul><h2 id=ui卡顿优化>UI卡顿优化</h2><h3 id=layout加载问题>layout加载问题</h3><p>正常的流程是在主线程先IO读取并递归解析一个xml文件，再通过反射创建View对象，效率很低，遇到复杂的layout，甚至可能引发ANR。</p><ul><li>使用约束布局，减少布局嵌套，减少递归；</li><li>使用<code>AsyncLayoutInflater</code>异步加载，不会阻塞主线程；</li><li>使用注解处理器+javaPoet在编译时生成View文件。（掌阅x2c原理）</li></ul><h3 id=重复绘制问题>重复绘制问题</h3><ul><li>使用约束布局，减少布局嵌套</li><li>去除看不见的背景图片</li><li>减少alpha的使用，使用alpha会导致View绘制两次，可使用ARGB色值替代</li></ul><h3 id=卡顿问题>卡顿问题</h3><ul><li>自定义View的onDraw优化</li><li>内存抖动频繁GC</li></ul><h3 id=排查工具>排查工具</h3><ul><li>Systrace</li><li>profile</li><li>adb</li></ul><h2 id=apk体积优化>apk体积优化</h2><ul><li>lint检查无效资源</li><li>混淆minifyEnabled</li><li>资源排除</li><li>图片压缩，webP，<code>VectorDrawable</code></li><li>使用tint前台改色复用图片</li><li>指定本地化语言</li><li>指定NDK</li><li>本地库压缩，在manifast文件中为application指定<code>android:extractNativeLibs = true</code></li></ul><h2 id=内存优化>内存优化</h2><h3 id=数据结构优化>数据结构优化</h3><h4 id=arraylist>ArrayList</h4><ul><li>初始化长度定位0，避免第一次add时扩容，空间换时间</li><li>增删时使用LinkedList，查询时转换成ArrayList</li><li>避免在中间插入和移除，这样会遍历改变下标，非常耗时，可以从末尾操作</li><li>使用HashMap替代，HashMap增删快，查询快</li></ul><h4 id=hashmap>HashMap</h4><ul><li>预估长度避免扩容</li><li>长度为2的整数倍，避免哈希冲突</li><li>使用SpaceArray替代，其核心是二维数组，并采用二分法提高查询效率。</li></ul><h2 id=崩溃监控>崩溃监控</h2><ul><li>Thread.setDefaultUnCauthExceptionHandler</li><li>linux错误信号</li><li></li></ul><h2 id=anr监控>ANR监控</h2><p>通过监听linux错误信号，经判断找出ANR错误，然后上报。</p><h2 id=安全性相关优化>安全性相关优化</h2></div></main></body></html>