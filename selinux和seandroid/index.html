<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=zh-CN lang=zh-cn><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>SELinux和SEAndroid &#183; Vee's space</title><meta name=description content><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/print.css media=print><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/poole.css><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/syntax.css><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><link href=https://vee-zhang.github.io/selinux%E5%92%8Cseandroid/index.md rel=alternate type=text/plain title="Vee's space"></head><body><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://vee-zhang.github.io><h1>Vee's space</h1></a><p class=lead>关于 DoIt 主题</p></div><nav><ul class=sidebar-nav><li><a href=https://vee-zhang.github.io>Home</a></li><li><a href=/posts/>所有文章</a></li><li><a href=/tags/>标签</a></li><li><a href=/categories/>分类</a></li><li><a href=/series/>系列</a></li><li><a href=/about/>关于</a></li></ul></nav><p>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</p></div></aside><main class="content container"><div class=post><h1>SELinux和SEAndroid</h1><time datetime=2022-12-12T10:18:18+0800 class=post-date>Mon, Dec 12, 2022</time><h3 id=模式>模式</h3><ul><li>宽容模式-Permissive:只打印audit异常log，不会拒绝请求；</li><li>强制模式-Enforce:即打印audit异常log，也会拒绝请求；</li></ul><h3 id=策略文件>策略文件</h3><h4 id=位置>位置</h4><p>SELinux策略文件用于定义域和标签，以<code>*.te</code>结尾。</p><p>Android自带的策略文件位于AOSP中的<code>system/sepolicy</code>中，我们尽量<strong>不要去修改这里的策略</strong>，而是应修改位于<code>device/manufacturer/device-name/sepolicy</code>目录下（其实就是croot/device/制造商/设备/sepolicy/）的.te文件，同时也<strong>尽量不要去新建.te文件，而是应该在原有的基础上修改</strong>。</p><blockquote><p>其实这里说的尽量不要，主要是针对企业，因为google有可能会找你麻烦，而且后续更新也会遇到问题，但是如果自己玩的话，想改就改。不过还是不建议改默认实现，否则升级之后又回退了。</p></blockquote><h4 id=格式>格式</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>allow source target:class permissions;
</span></span></code></pre></td></tr></table></div></div><ul><li>source:规则主题的类型（或属性），代表谁正在申请访问权限；</li><li>target:对象类型（或属性），对哪些内容提出了访问权限；</li><li>class:要访问的对象（）的类型;</li><li>permissions:要执行的操作。</li></ul><p>eg:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>allow untrusted_app app_data_file:file {read write}; 
</span></span></code></pre></td></tr></table></div></div><h4 id=宏>宏</h4><p>如果要添加的权限很多，为了简化规则定义，SEAndroid提供了宏，比如上面的例子可以这样写：</p><p>eg:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>allow untrusted_app app_data_file:file rw_file_perms; 
</span></span></code></pre></td></tr></table></div></div><h3 id=上下文描述文件>上下文描述文件</h3><p>在<code>device/manufacturer/device-name/sepolicy</code>中存在各种上下文描述文件，主要<strong>负责为target打标签</strong>。</p><h4 id=列举>列举</h4><ul><li><code>file_contexts</code>用于为文件分配标签，并且可供多种用户空间时用。</li><li><code>genfs_contexts</code>用于为不支持扩展属性的文件系统分配标签。</li><li><code>property_contexts</code>用于为Android系统属性分配标签，以便控制那些进程可以为设置这些属性。再启动期间，<code>init</code>进程会读取这些配置。</li><li><code>service_contexts</code>用于为Android Binder服务分配标签，以便控制那些进程可以为相应服务添加（注册）和查找Binder引用。在启动期间，<code>servicemanager</code>进程会读取此配置。</li><li><code>seapp_contexts</code>用于为应用进程和<code>/data/data</code>目录分配标签。在每次应用启动时，<code>zygote</code>进程都会读取此配置；在启动期间，<code>installd</code>会读取此配置。</li><li><code>mac_permissions.xml</code>用于根据应用签名和应用软件包名称为应用分配<code>seinfo</code>标记。分配的<code>seinfo</code>标记可在<code>seapp_contexts</code>文件中用做密钥，以便为带有该<code>seinfo</code>标记的所有应用分配特定标签。在启动期间，<code>sestem_server</code>会读取此配置。</li></ul><h4 id=格式-1>格式</h4><p>我们打开file_contexts文件，查看一下格式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/mnt/vendor/crypto(/.*)?                            u:object_r:mnt_vendor_crypto_file:s0
</span></span><span class=line><span class=cl>/(vendor|system/vendor)/bin/delete7dayslog.sh       u:object_r:delete_seven_day_log-sh_exec:s0
</span></span></code></pre></td></tr></table></div></div><p>就是<strong>目录+标签</strong>的方式，看起来很像host的定义。</p><p>这里要注意的是：</p><ul><li>目录支持正则表达式</li><li>u，object_r,s0都是固定的</li></ul><h3 id=boardconfigmk>BoardConfig.mk</h3><p>当修改或添加了策略文件和上下文描述文件后，需要更新<code>/device/manufacturer/device-name/BoardConfig.mk</code>来引用生效。</p><p>eg:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>BOARD_SEPOLICY_DIRS += \
</span></span><span class=line><span class=cl>        &lt;root&gt;/device/manufacturer/device-name/sepolicy
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>BOARD_SEPOLICY_UNION += \
</span></span><span class=line><span class=cl>        genfs_contexts \
</span></span><span class=line><span class=cl>        file_contexts \
</span></span><span class=line><span class=cl>        sepolicy.te
</span></span></code></pre></td></tr></table></div></div><p><strong>最后需要需要重新编译才能生效！</strong></p><h3 id=启动用selinux>启动用SELinux</h3><ol><li>在内核中启用（eg:在kernel/msm-5.4/kernel/configs/android-base.config）中配置：<code>CONFIG_SECURITY_SELINUX=y</code>;</li><li>更改Kernel_cmdline参数：<code>BOARD_KERNEL_CMDLINE := androidboot.selinux=permissive</code>,发版前应该移除此参数以变更为强制模式；</li></ol><h3 id=查看开机时的拒绝事件>查看开机时的拒绝事件</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>adb root
</span></span><span class=line><span class=cl>adb shell dmesg <span class=p>|</span> grep audit <span class=p>|</span> grep av
</span></span></code></pre></td></tr></table></div></div><p>返回：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[    1.979517] audit: type=1400 audit(1.969:4): avc:  denied  { relabelfrom } for  pid=261 comm=&#34;init&#34; name=&#34;/&#34; dev=&#34;tmpfs&#34; ino=10968 scontext=u:r:vendor_init:s0 tcontext=u:object_r:tmpfs:s0 tclass=dir permissive=0
</span></span></code></pre></td></tr></table></div></div><h3 id=查看scontext>查看SContext</h3><p>标准的SContext格式如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>user:role:type[:range]
</span></span></code></pre></td></tr></table></div></div><ul><li>User:用户，这里的用户并非linux的UID;</li><li>Role：角色，不同的Role具有不同的权限；</li><li>Type:Subject或者Object的类型，对于进程来说，type就是domain。</li><li>Range：MSL级别。MLS将系统的进程和文件进行了分级，不同级别的资源需要对应级别的进程才能访问。</li></ul><h4 id=文件的scontext>文件的SContext</h4><p>命令：<code>ls -Z</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> u:object_r:system_file:s0         system
</span></span></code></pre></td></tr></table></div></div><ul><li>u:该文件的SELinux用户,在SEAndroid中只有一个SELinux用户，就是u；</li><li>object_r:角色，这里的object_r表示固定不变的东西，如文件，在SEAndroid中只定义了两个role，适用于主题的<code>r</code>和适用于对象的<code>object_r</code>；</li><li>system_file:类型，这里表示system目录的类型；</li><li>s0:MLS的敏感度，默认就是<code>s0</code>。</li></ul><h4 id=进程的scontext>进程的SContext</h4><p>命令：<code>ps -Z</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>LABEL          USER        PID   PPID    VSZ     RSS     WCHAN       ADDR S NAME                       
</span></span><span class=line><span class=cl>u:r:su:s0      root       25497  8935    9320    3144   sigsuspend      0 S sh
</span></span><span class=line><span class=cl>u:r:su:s0      root       27256  25497   11788   3128   0               0 R ps
</span></span></code></pre></td></tr></table></div></div><p>最左侧LABEL这一列就是进程的<code>SContext</code>：</p><ul><li>u:就是SELinux用户（user）；</li><li>r:为角色（role），相当于用户组；</li><li>su:代表该进程所属的<strong>域</strong>为SU;</li><li>s0:MLS级别。</li></ul><p>==================================================to be continue========</p></div></main></body></html>