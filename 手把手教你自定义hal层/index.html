<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title class="pjax-title">手把手教你自定义HAL层 - Vee&#39;s space</title><meta name="Description" content="关于 DoIt 主题"><meta property="og:title" content="手把手教你自定义HAL层" />
<meta property="og:description" content="最近工作要求，涉及到了HAL层开发，让我这个刚刚从上层转底层的小白无所适从，根本不知道怎么入手，从网上搜集了大堆的文章，照着做没有一个能成，前前后后一个月了，今天终于成功了，特此记录一下，希望能帮到其他像我一样高转低的同行吧。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://vee-zhang.github.io/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E8%87%AA%E5%AE%9A%E4%B9%89hal%E5%B1%82/" /><meta property="og:image" content="https://vee-zhang.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-03T17:30:15+08:00" />
<meta property="article:modified_time" content="2022-08-03T17:30:15+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://vee-zhang.github.io/logo.png"/>

<meta name="twitter:title" content="手把手教你自定义HAL层"/>
<meta name="twitter:description" content="最近工作要求，涉及到了HAL层开发，让我这个刚刚从上层转底层的小白无所适从，根本不知道怎么入手，从网上搜集了大堆的文章，照着做没有一个能成，前前后后一个月了，今天终于成功了，特此记录一下，希望能帮到其他像我一样高转低的同行吧。"/>
<meta name="application-name" content="Vee&#39;s space">
<meta name="apple-mobile-web-app-title" content="Vee&#39;s space">

<meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://vee-zhang.github.io/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E8%87%AA%E5%AE%9A%E4%B9%89hal%E5%B1%82/" /><link rel="prev" href="https://vee-zhang.github.io/%E7%BC%96%E8%AF%91%E6%8A%80%E5%B7%A7/" /><link rel="next" href="https://vee-zhang.github.io/ubuntu22.04%E4%B8%8A%E4%B8%8D%E8%83%BD%E4%BD%BF%E7%94%A8adb/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="MQ8DNu27ayX6B_4ObiEDK09vGr1fdy7kOAnbd09hJk4" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "手把手教你自定义HAL层",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/vee-zhang.github.io\/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E8%87%AA%E5%AE%9A%E4%B9%89hal%E5%B1%82\/"
        },"image": ["https:\/\/vee-zhang.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","wordcount":  5977 ,
        "url": "https:\/\/vee-zhang.github.io\/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E8%87%AA%E5%AE%9A%E4%B9%89hal%E5%B1%82\/","datePublished": "2022-08-03T17:30:15+08:00","dateModified": "2022-08-03T17:30:15+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/vee-zhang.github.io\/images\/avatar.webp",
                    "width":  528 ,
                    "height":  560 
                }},"author": {
                "@type": "Person",
                "name": "Vee Zhang"
            },"description": ""
    }
    </script></head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme);}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('auto' === 'light' || 'auto' === 'dark' || 'auto' === 'black') setTheme('auto'), saveTheme('auto'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let themeColorMeta = getMeta('theme-color');
        if (document.body.getAttribute('theme') != 'light') themeColorMeta.content = '#000000';
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Vee&#39;s space"><span class="header-title-pre"><i class='far fa-edit fa-fw'></i></span>Vee&#39;s space</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/series/"> 系列 </a><a class="menu-item" href="/about/"> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="#" onclick="return false;" class="menu-item theme-select" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                    <select class="color-theme-select" id="theme-select-desktop" title="切换主题">
                        <option value="light">浅色</option>
                        <option value="dark">深色</option>
                        <option value="black">黑色</option>
                        <option value="auto">跟随系统</option>
                    </select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Vee&#39;s space"><span class="header-title-pre"><i class='far fa-edit fa-fw'></i></span>Vee&#39;s space</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" onclick="return false;" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/series/" title="">系列</a><a class="menu-item" href="/about/" title="">关于</a><a href="#" onclick="return false;" class="menu-item theme-select" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
                <select class="color-theme-select" id="theme-select-mobile" title="切换主题">
                    <option value="light">浅色</option>
                    <option value="dark">深色</option>
                    <option value="black">黑色</option>
                    <option value="auto">跟随系统</option>
                </select>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content" id="toc-content-auto"></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "wide")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">手把手教你自定义HAL层</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><a href="https://github.com/vee-zhang" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="author fas fa-user-circle fa-fw"></i>Vee Zhang</a>
                </span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-08-03">2022-08-03</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 5977 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 12 分钟&nbsp;<span id="/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E8%87%AA%E5%AE%9A%E4%B9%89hal%E5%B1%82/" class="leancloud_visitors" data-flag-title="手把手教你自定义HAL层">
                        <i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count id=twikoo_visitors></span>&nbsp;次阅读
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#环境介绍">环境介绍</a></li>
    <li><a href="#编译过程">编译过程</a>
      <ul>
        <li><a href="#定义软件包文件结构">定义软件包文件结构</a></li>
        <li><a href="#创建hidl文件">创建HIDL文件</a>
          <ul>
            <li><a href="#ihelloworldhal">IHelloWorld.hal</a></li>
            <li><a href="#ihelloworldcallbackhal">IHelloWorldCallback.hal</a></li>
            <li><a href="#typeshal">types.hal</a></li>
          </ul>
        </li>
        <li><a href="#指定interfaces为软件包根目录">指定interfaces为软件包根目录</a></li>
        <li><a href="#用hidl-gen工具生成相关文件">用hidl-gen工具生成相关文件</a></li>
        <li><a href="#生成版本控制文件">生成版本控制文件</a></li>
        <li><a href="#生成hidl的实现">生成HIDL的实现</a>
          <ul>
            <li><a href="#helloworldh">HelloWorld.h</a></li>
            <li><a href="#heloworldcpp">HeloWorld.cpp:</a></li>
            <li><a href="#servicecpp">service.cpp</a></li>
            <li><a href="#initrc">init.rc</a></li>
          </ul>
        </li>
        <li><a href="#生成androidbp">生成Android.bp</a></li>
        <li><a href="#在编译类型中注册hal服务">在编译类型中注册HAL服务</a></li>
        <li><a href="#添加本地c测试">添加本地c++测试</a></li>
        <li><a href="#编译出运行库">编译出运行库</a></li>
      </ul>
    </li>
    <li><a href="#测试">测试</a>
      <ul>
        <li><a href="#推送包到设备">推送包到设备</a></li>
        <li><a href="#启动服务">启动服务</a></li>
        <li><a href="#启动测试">启动测试</a></li>
        <li><a href="#java层app调试">Java层App调试</a></li>
      </ul>
    </li>
    <li><a href="#后记">后记</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>最近工作要求，涉及到了HAL层开发，让我这个刚刚从上层转底层的小白无所适从，根本不知道怎么入手，从网上搜集了大堆的文章，照着做没有一个能成，前前后后一个月了，今天终于成功了，特此记录一下，希望能帮到其他像我一样高转低的同行吧。</p>
<blockquote>
<p>本文大量借鉴<a href="https://www.codenong.com/cs109234795/" target="_blank" rel="noopener noreffer">这篇文章</a>，非常感谢原作！</p>
</blockquote>
<h2 id="环境介绍">环境介绍</h2>
<ul>
<li>aosp版本：android9</li>
<li>电脑操作系统：ubuntu20.04LTS</li>
<li>手机：google-pixcel-3xl-欧版</li>
</ul>
<h2 id="编译过程">编译过程</h2>
<h3 id="定义软件包文件结构">定义软件包文件结构</h3>
<p>我们定义的一部分相关功能的集合，叫做<strong>软件包</strong>。</p>
<p>软件包名称可以具有子集，如<code>package.subpackage</code>，其根目录为<code>hardware/interfaces</code>或<code>vendor/vendorName</code>。软件包名称，在根目录下形成一个或多个子目录。</p>
<p>AOSP中的软件包分布如下：</p>
<table>
<thead>
<tr>
<th>前缀</th>
<th>位置</th>
<th>类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>android.hardware.*</td>
<td>hardware/interfaces/*</td>
<td>HAL</td>
</tr>
<tr>
<td>android.frameworks.*</td>
<td>frameworks/hardware/interfaces/*</td>
<td>frameworks/ 相关</td>
</tr>
<tr>
<td>android.system.*</td>
<td>system/hardware/interfaces/*</td>
<td>system/ 相关</td>
</tr>
<tr>
<td>android.hidl.*</td>
<td>system/libhidl/transport/*</td>
<td>核心</td>
</tr>
</tbody>
</table>
<p>从上表看到，我们的HAL应该位于hardware/interfaces/*中，但由于AOSP某些分支是锁定的，不允许修改VNDK库列表，所以我们不能直接修改<code>hardware/interfaces/*</code>中的文件，一个很好的解决方式就是在我们的厂商目录<code>vendor</code>中建立同样的<code>hardware/interfaces/*</code>，然后映射到AOSP根目录下的相同位置。这种类型的HAL叫做<strong>厂商扩展</strong>。</p>
<p>接下来我们就定义一个软件包的目录结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mkdir -p vendor/sample/hardware/interfaces/helloworld/1.0
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们在<code>vendor</code>中创建hal模块，仔细研究目录结构：</p>
<ul>
<li>sample是我们的组织名称；</li>
<li>hardware/interfaces映射着着根目录里面的hardware/interfaces；</li>
<li>interfaces后面将作为我们的root目录；</li>
<li>helloworld是模块名称；</li>
<li>1.0是一个版本目录，以后可能还有2.0,3.0。</li>
</ul>
<blockquote>
<p>网上很多文章都是直接在根目录下的hardware/interface中操作，我试了很多次都编译失败了，都是关于VNDK的报错，VNDK是啥我都不知道，也没办法解决。后来才知道，不要直接在Android源码目录hardware/interfaces下面添加和修改接口,在API锁定分支中不允许更改VNDK库列表。</p>
</blockquote>
<h3 id="创建hidl文件">创建HIDL文件</h3>
<p>接下来，我们在<code>1.0</code>目录中创建三个<code>.hal</code>文件：</p>
<h4 id="ihelloworldhal">IHelloWorld.hal</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">sample</span><span class="p">.</span><span class="nx">hardware</span><span class="p">.</span><span class="nx">helloworld</span><span class="err">@</span><span class="mf">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nx">IHelloWorldCallback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">interface</span> <span class="nx">IHelloWorld</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">initial</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">getInt</span><span class="p">()</span> <span class="nf">generates</span> <span class="p">(</span><span class="nx">int32_t</span> <span class="nx">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setInt</span><span class="p">(</span><span class="nx">int32_t</span> <span class="nx">val</span><span class="p">)</span> <span class="nf">generates</span> <span class="p">(</span><span class="nx">Result</span> <span class="kt">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">oneway</span> <span class="nf">setCallback</span><span class="p">(</span><span class="nx">IHelloWorldCallback</span> <span class="nx">callback</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>写法非常类似<code>AIDL</code>，事实上，<strong>从Android11开始，google已经用AIDL去替代HIDL</strong>,所以对于HIDL大概理解就行，没必要下功夫去学。</p>
<p>内容不多，我们在此声明了四个虚方法，后面会一一实现。</p>
<h4 id="ihelloworldcallbackhal">IHelloWorldCallback.hal</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">sample</span><span class="p">.</span><span class="nx">hardware</span><span class="p">.</span><span class="nx">helloworld</span><span class="err">@</span><span class="mf">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">interface</span> <span class="nx">IHelloWorldCallback</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">oneway</span> <span class="nf">onEvent</span><span class="p">(</span><span class="nx">Event</span> <span class="nx">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="typeshal">types.hal</h4>
<p><code>types.hal</code>文件并没有定义接口，而是用来定义软件包中每个接口可以访问的数据类型。根据Google的规范，这个文件的名称必须是types.hal。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">sample</span><span class="p">.</span><span class="nx">hardware</span><span class="p">.</span><span class="nx">helloworld</span><span class="err">@</span><span class="mf">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">enum</span> <span class="nx">Result</span> <span class="p">:</span> <span class="nx">int32_t</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">OK</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">UNKNOWN</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">INVALID_ARGUMENTS</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">struct</span> <span class="nx">Event</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">uint32_t</span> <span class="kd">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">uint32_t</span> <span class="nx">code</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">uint32_t</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后注意一下<code>package</code>包声明，是与目录有一定联系的！</p>
<h3 id="指定interfaces为软件包根目录">指定interfaces为软件包根目录</h3>
<p>在interfaces中创建<code>Android.bp</code>文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">hidl_package_root {
</span></span><span class="line"><span class="cl">    name: &#34;sample.hardware&#34;,
</span></span><span class="line"><span class="cl">    path: &#34;vendor/sample/hardware/interfaces&#34;,
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们知道<code>.bp</code>文件是用来描述软件包的，这里就是把interfaces指定为“sample.hardware”软件包的根目录。</p>
<blockquote>
<p>如果没有指定目录，编译时会报错：Cannot find package root specification</p>
</blockquote>
<h3 id="用hidl-gen工具生成相关文件">用hidl-gen工具生成相关文件</h3>
<p><code>hidl-gen</code>是google提供的，用来生成hidl相关文件的工具，但他本身是以源码的形式，放在aosp代码中提供的，所以使用前需要先编译这玩意：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cd到android9的根目录
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">source build/envsetup.sh
</span></span><span class="line"><span class="cl">lunch 20
</span></span><span class="line"><span class="cl">make hidl-gen -j4
</span></span></code></pre></td></tr></table>
</div>
</div><p>为了方便，我们可以先定义几个环境变量，一会要重复使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">// 包名
</span></span><span class="line"><span class="cl"><span class="nv">PACKAGE</span><span class="o">=</span>sample.hardware
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 软件名
</span></span><span class="line"><span class="cl"><span class="nv">NAME</span><span class="o">=</span><span class="nv">$PACKAGE</span>.helloworld@1.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 软件包根目录
</span></span><span class="line"><span class="cl"><span class="nv">ROOT</span><span class="o">=</span>vendor/sample/hardware/interfaces
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// hidl实现文件存放的位置
</span></span><span class="line"><span class="cl"><span class="nv">LOC</span><span class="o">=</span><span class="nv">$ROOT</span>/helloworld/1.0/default
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="生成版本控制文件">生成版本控制文件</h3>
<p>版本控制文件是位于软件包根目录下的<code>current.txt</code>,用来做OTA升级时，确认软件包版本信息的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">hidl-gen -Lhash -r<span class="nv">$PACKAGE</span>:<span class="nv">$ROOT</span> -randroid.hidl:system/libhidl/transport <span class="nv">$NAME</span>&gt; <span class="nv">$ROOT</span>/current.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p>在$ROOT下会出现一个current.txt文件，里面是所有hidl的哈希，用来标记版本。</p>
<h3 id="生成hidl的实现">生成HIDL的实现</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">hidl-gen -o <span class="nv">$LOC</span> -Lc++-impl -r<span class="nv">$PACKAGE</span>:<span class="nv">$ROOT</span> -randroid.hidl:system/libhidl/transport <span class="nv">$NAME</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在$LOC下会生成HIDL的c++实现文件，我们需要修改成自己的实现。</p>
<h4 id="helloworldh">HelloWorld.h</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#ifndef SAMPLE_HARDWARE_HELLOWORLD_V1_0_HELLOWORLD_H
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SAMPLE_HARDWARE_HELLOWORLD_V1_0_HELLOWORLD_H
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sample/hardware/helloworld/1.0/IHelloWorld.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;hidl/MQDescriptor.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;hidl/Status.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">sample</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">hardware</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">helloworld</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">V1_0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">implementation</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="o">::</span><span class="n">android</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">hidl_array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="o">::</span><span class="n">android</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">hidl_memory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="o">::</span><span class="n">android</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">hidl_string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="o">::</span><span class="n">android</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">hidl_vec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="o">::</span><span class="n">android</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">Return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="o">::</span><span class="n">android</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">Void</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="o">::</span><span class="n">android</span><span class="o">::</span><span class="n">sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">HelloWorld</span> <span class="o">:</span> <span class="k">public</span> <span class="n">IHelloWorld</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Return</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">initial</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Return</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span> <span class="n">getInt</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Return</span><span class="o">&lt;::</span><span class="n">sample</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">helloworld</span><span class="o">::</span><span class="n">V1_0</span><span class="o">::</span><span class="n">Result</span><span class="o">&gt;</span> <span class="n">setInt</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">val</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Return</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">setCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">sp</span><span class="o">&lt;::</span><span class="n">sample</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">helloworld</span><span class="o">::</span><span class="n">V1_0</span><span class="o">::</span><span class="n">IHelloWorldCallback</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">callback</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">pollThreadWrapper</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">me</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">pollThreadEntry</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_mutex_t</span> <span class="n">mLock</span> <span class="o">=</span> <span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_t</span> <span class="n">mPollThread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">mRunning</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">sp</span><span class="o">&lt;</span><span class="n">IHelloWorldCallback</span><span class="o">&gt;&gt;</span> <span class="n">mCallbacks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>  <span class="c1">// namespace implementation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>  <span class="c1">// namespace V1_0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>  <span class="c1">// namespace helloworld
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>  <span class="c1">// namespace hardware
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>  <span class="c1">// namespace sample
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif  </span><span class="c1">// SAMPLE_HARDWARE_HELLOWORLD_V1_0_HELLOWORLD_H
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="heloworldcpp">HeloWorld.cpp:</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#define LOG_TAG &#34;sample.hardware.helloworld@1.0-service&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;android-base/logging.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;log/log.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;HelloWorld.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">sample</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">hardware</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">helloworld</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">V1_0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">implementation</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Return</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">HelloWorld</span><span class="o">::</span><span class="n">initial</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ALOGD</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">mRunning</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Void</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mRunning</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_attr_t</span> <span class="n">attr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_attr_setdetachstate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">PTHREAD_CREATE_JOINABLE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mPollThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">pollThreadWrapper</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_attr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">Void</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Return</span><span class="o">&lt;</span><span class="kt">int32_t</span><span class="o">&gt;</span> <span class="n">HelloWorld</span><span class="o">::</span><span class="n">getInt</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ALOGD</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kt">int32_t</span><span class="p">{</span><span class="mi">666</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Return</span><span class="o">&lt;::</span><span class="n">sample</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">helloworld</span><span class="o">::</span><span class="n">V1_0</span><span class="o">::</span><span class="n">Result</span><span class="o">&gt;</span> <span class="n">HelloWorld</span><span class="o">::</span><span class="n">setInt</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ALOGD</span><span class="p">(</span><span class="s">&#34;%s %d&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">::</span><span class="n">sample</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">helloworld</span><span class="o">::</span><span class="n">V1_0</span><span class="o">::</span><span class="n">Result</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="n">HelloWorld</span><span class="o">::</span><span class="n">pollThreadWrapper</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">me</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">HelloWorld</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">me</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pollThreadEntry</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">HelloWorld</span><span class="o">::</span><span class="n">pollThreadEntry</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">mRunning</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ALOGD</span><span class="p">(</span><span class="s">&#34;%s enter&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Event</span> <span class="n">event</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">event</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">event</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">event</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">mRunning</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">event</span><span class="p">.</span><span class="n">code</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">event</span><span class="p">.</span><span class="n">type</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">event</span><span class="p">.</span><span class="n">value</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ALOGD</span><span class="p">(</span><span class="s">&#34;%s event %04x %04x %04x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">code</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mLock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mCallbacks</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">sp</span><span class="o">&lt;</span><span class="n">IHelloWorldCallback</span><span class="o">&gt;&gt;::</span><span class="n">iterator</span> <span class="n">it</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="n">it</span> <span class="o">=</span> <span class="n">mCallbacks</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">mCallbacks</span><span class="p">.</span><span class="n">end</span><span class="p">();)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">sp</span><span class="o">&lt;</span><span class="n">IHelloWorldCallback</span><span class="o">&gt;</span> <span class="n">callback</span> <span class="o">=</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">Return</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">callback</span><span class="o">-&gt;</span><span class="n">onEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">.</span><span class="n">isOk</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ALOGE</span><span class="p">(</span><span class="s">&#34;error %s&#34;</span><span class="p">,</span> <span class="n">ret</span><span class="p">.</span><span class="n">description</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                    <span class="n">it</span> <span class="o">=</span> <span class="n">mCallbacks</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">it</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mLock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ALOGD</span><span class="p">(</span><span class="s">&#34;%s exit&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Return</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">HelloWorld</span><span class="o">::</span><span class="n">setCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">sp</span><span class="o">&lt;::</span><span class="n">sample</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">helloworld</span><span class="o">::</span><span class="n">V1_0</span><span class="o">::</span><span class="n">IHelloWorldCallback</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">callback</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ALOGD</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mLock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">callback</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mCallbacks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">callback</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mLock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">Void</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>  <span class="c1">// namespace implementation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>  <span class="c1">// namespace V1_0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>  <span class="c1">// namespace helloworld
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>  <span class="c1">// namespace hardware
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>  <span class="c1">// namespace sample
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="servicecpp">service.cpp</h4>
<p>以上全都是c++代码，c++需要一个<code>main</code>入口函数才能启动，接下来就要实现一个service作为入口，创建<code>$LOC/service.cpp</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#define LOG_TAG &#34;sample.hardware.helloworld@1.0-service&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;android-base/logging.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;hidl/HidlTransportSupport.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;HelloWorld.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">android</span><span class="o">::</span><span class="n">OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">android</span><span class="o">::</span><span class="n">sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">android</span><span class="o">::</span><span class="n">status_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">android</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">configureRpcThreadpool</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">android</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">joinRpcThreadpool</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">sample</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">helloworld</span><span class="o">::</span><span class="n">V1_0</span><span class="o">::</span><span class="n">IHelloWorld</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">sample</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">helloworld</span><span class="o">::</span><span class="n">V1_0</span><span class="o">::</span><span class="n">implementation</span><span class="o">::</span><span class="n">HelloWorld</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="cm">/* argc */</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="cm">/* argv */</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ALOGD</span><span class="p">(</span><span class="s">&#34;HAL Service is starting.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sp</span><span class="o">&lt;</span><span class="n">IHelloWorld</span><span class="o">&gt;</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HelloWorld</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">configureRpcThreadpool</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">true</span> <span class="cm">/*callerWillJoin*/</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">status_t</span> <span class="n">status</span> <span class="o">=</span> <span class="n">service</span><span class="o">-&gt;</span><span class="n">registerAsService</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG_ALWAYS_FATAL</span><span class="p">(</span><span class="s">&#34;Could not register service for HelloWorld HAL Iface (%d).&#34;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ALOGD</span><span class="p">(</span><span class="s">&#34;Register as service ready.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">joinRpcThreadpool</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// joinRpcThreadpool shouldn&#39;t exit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑很简单，创建了<code>main</code>入口函数，在其中new了一个HelloWorld类，并调用其<code>registerAsService()</code>函数。</p>
<p>然后需要把service添加进Android.bp，才会被编译，修改后的<code>$LOC/Android.bp</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cc_library_shared {
</span></span><span class="line"><span class="cl">    name: &#34;sample.hardware.helloworld@1.0-impl&#34;,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // 要把proprietary: true改为vendor: true
</span></span><span class="line"><span class="cl">    vendor: true,
</span></span><span class="line"><span class="cl">    // 删除下面这一行
</span></span><span class="line"><span class="cl">    //relative_install_path: &#34;hw&#34;,
</span></span><span class="line"><span class="cl">    srcs: [
</span></span><span class="line"><span class="cl">        &#34;HelloWorld.cpp&#34;,
</span></span><span class="line"><span class="cl">    ],
</span></span><span class="line"><span class="cl">    shared_libs: [
</span></span><span class="line"><span class="cl">        &#34;liblog&#34;,
</span></span><span class="line"><span class="cl">        &#34;libhidlbase&#34;,
</span></span><span class="line"><span class="cl">        &#34;libhidltransport&#34;,
</span></span><span class="line"><span class="cl">        &#34;libutils&#34;,
</span></span><span class="line"><span class="cl">        &#34;sample.hardware.helloworld@1.0&#34;,
</span></span><span class="line"><span class="cl">    ],
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cc_binary {
</span></span><span class="line"><span class="cl">    name: &#34;sample.hardware.helloworld@1.0-service&#34;,
</span></span><span class="line"><span class="cl">    defaults: [&#34;hidl_defaults&#34;],
</span></span><span class="line"><span class="cl">    vendor: true,
</span></span><span class="line"><span class="cl">    relative_install_path: &#34;hw&#34;,
</span></span><span class="line"><span class="cl">    init_rc: [&#34;sample.hardware.helloworld@1.0-service.rc&#34;],
</span></span><span class="line"><span class="cl">    srcs: [&#34;service.cpp&#34;],
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    shared_libs: [
</span></span><span class="line"><span class="cl">        &#34;libcutils&#34;,
</span></span><span class="line"><span class="cl">        &#34;libhidlbase&#34;,
</span></span><span class="line"><span class="cl">        &#34;libhidltransport&#34;,
</span></span><span class="line"><span class="cl">        &#34;liblog&#34;,
</span></span><span class="line"><span class="cl">        &#34;libutils&#34;,
</span></span><span class="line"><span class="cl">        &#34;libhardware&#34;,
</span></span><span class="line"><span class="cl">        &#34;sample.hardware.helloworld@1.0&#34;,
</span></span><span class="line"><span class="cl">        &#34;sample.hardware.helloworld@1.0-impl&#34;,
</span></span><span class="line"><span class="cl">    ],
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>这里要注意，将cc_library_shared节点proprietary: true改为vendor: true;删除relative_install_path: “hw”,目的是将sample.hardware.helloworld@1.0-impl.so编译安装到vendor/lib64目录下面,如果vendor/lib64/hw下面,运行服务时因VNDK规则限制,会报错:F linker : CANNOT LINK EXECUTABLE “./vendor/bin/hw/sample.hardware.helloworld@1.0-service”: library “sample.hardware.helloworld@1.0-impl.so” not found</p>
</blockquote>
<p>到这里我们就成功添加了程序入口，但是问题又来了，有了入口函数，系统怎么认识他呢？为了让系统认识他，我们需要添加init.rc文件，为系统做指引。</p>
<h4 id="initrc">init.rc</h4>
<p>创建<code>$LOC/$NAME@1.0-service.rc</code>文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">service vendor.helloworld-1-0 /vendor/bin/hw/sample.hardware.helloworld@1.0-service
</span></span><span class="line"><span class="cl">    class hal
</span></span><span class="line"><span class="cl">    user system
</span></span><span class="line"><span class="cl">    group system
</span></span></code></pre></td></tr></table>
</div>
</div><p>init.rc文件的意义，就是把我们刚刚添加的程序入口，作为服务启动：</p>
<ul>
<li>第一行，创建一个service？？？</li>
<li>第二行，service类型为hal；</li>
<li>第三行，用户为system</li>
<li>第四行，用户组为system</li>
</ul>
<p>有了实现，但是系统并不会编译它，下一步就是生成Android.bp，指导系统如何编译。</p>
<h3 id="生成androidbp">生成Android.bp</h3>
<p>生成$LOC下的Android.bp:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">hidl-gen -o <span class="nv">$LOC</span> -Landroidbp-impl -r<span class="nv">$PACKAGE</span>:<span class="nv">$ROOT</span> -randroid.hidl:system/libhidl/transport <span class="nv">$NAME</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>生成$ROOT/helloworld/1.0中的Android.bp：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nb">source</span> <span class="nv">$ANDROID_BUILD_TOP</span>/system/tools/hidl/update-makefiles-helper.sh
</span></span><span class="line"><span class="cl">$ do_makefiles_update <span class="nv">$PACKAGE</span>:ROOT android.hardware:hardware/interfaces android.hidl:system/libhidl/transport
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="在编译类型中注册hal服务">在编译类型中注册HAL服务</h3>
<p>在<code>devices</code>中的对应厂商的对应编译类型（lunch指令的编译目标）目录下修改manifest.xml文件，比如我的aosp,对应调试手机为<code>google-pixel-3xl</code>,我在lunch时的目标类型是<code>aosp-crosshatch-userdebug</code>，那么就应该去修改<code>device/google/crosshatch/manifest.xml</code>文件。在文件中加入：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;hal</span> <span class="na">format=</span><span class="s">&#34;hidl&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;name&gt;</span>sample.hardware.helloworld<span class="nt">&lt;/name&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;transport&gt;</span>hwbinder<span class="nt">&lt;/transport&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;interface&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;name&gt;</span>IHelloWorld<span class="nt">&lt;/name&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;instance&gt;</span>default<span class="nt">&lt;/instance&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/interface&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/hal&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后整编一下，更新manifest.xml。</p>
<blockquote>
<p>这里不更新manifest.xml,可能会报错：W hwservicemanager: getTransport: Cannot find entry <a href="mailto:sample.hardware.helloworld@1.0" rel="">sample.hardware.helloworld@1.0</a>::IHelloWorld/default in either framework or device manifest.</p>
</blockquote>
<p>在这里我遇到了报错：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span> 25% 4/16<span class="o">]</span> build out/target/product/crosshatch/gen/ETC/framework_compatibility_matrix.xml_intermediates/compatibility_matrix.xml
</span></span><span class="line"><span class="cl">FAILED: out/target/product/crosshatch/gen/ETC/framework_compatibility_matrix.xml_intermediates/compatibility_matrix.xml 
</span></span><span class="line"><span class="cl">/bin/bash -c <span class="s2">&#34;PRODUCT_ENFORCE_VINTF_MANIFEST=\&#34;true\&#34;           VINTF_ENFORCE_NO_UNUSED_HALS=true               out/host/linux-x86/bin/assemble_vintf           -i out/target/product/crosshatch/system/etc/vintf/compatibility_matrix.legacy.xml:out/target/product/crosshatch/system/etc/vintf/compatibility_matrix.1.xml:out/target/product/crosshatch/system/etc/vintf/compatibility_matrix.2.xml:out/target/product/crosshatch/system/etc/vintf/compatibility_matrix.3.xml:out/target/product/crosshatch/system/etc/vintf/compatibility_matrix.device.xml            -o out/target/product/crosshatch/gen/ETC/framework_compatibility_matrix.xml_intermediates/compatibility_matrix.xml             -c \&#34;out/target/product/crosshatch/obj/ETC/device_manifest.xml_intermediates/manifest.xml\&#34;&#34;</span>
</span></span><span class="line"><span class="cl">Error: The following instances are in the device manifest but not specified in framework compatibility matrix: 
</span></span><span class="line"><span class="cl">    sample.hardware.helloworld@1.0::IHelloWorld/default
</span></span><span class="line"><span class="cl">Suggested fix:
</span></span><span class="line"><span class="cl">1. Check <span class="k">for</span> any typos in device manifest or framework compatibility matrices with FCM version &gt;<span class="o">=</span> 3.
</span></span><span class="line"><span class="cl">2. Add them to any framework compatibility matrix with FCM version &gt;<span class="o">=</span> <span class="m">3</span> where applicable.
</span></span><span class="line"><span class="cl">3. Add them to DEVICE_FRAMEWORK_COMPATIBILITY_MATRIX_FILE.
</span></span><span class="line"><span class="cl">ninja: build stopped: subcommand failed.
</span></span><span class="line"><span class="cl">10:01:12 ninja failed with: <span class="nb">exit</span> status <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#### failed to build some targets (7 seconds) ####</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>猜想原因，是因为由于锁定分支的关系，我们没有直接在<code>hardware/interfaces/*</code>中建立我们的hal,而是在厂商目录<code>vendor</code>中玩的。</p>
<p>注意看错误信息：<code>Error: The following instances are in the device manifest but not specified in framework compatibility matrix:  sample.hardware.helloworld@1.0::IHelloWorld/default</code>。意思是说，我们虽然在device的manifest中添加了一个实例，但是没有在framework compatibility matrix中指定。</p>
<p>然后下面给出了3条建议：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">1. Check <span class="k">for</span> any typos in device manifest or framework compatibility matrices with FCM version &gt;<span class="o">=</span> 3.
</span></span><span class="line"><span class="cl">2. Add them to any framework compatibility matrix with FCM version &gt;<span class="o">=</span> <span class="m">3</span> where applicable.
</span></span><span class="line"><span class="cl">3. Add them to DEVICE_FRAMEWORK_COMPATIBILITY_MATRIX_FILE.
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后根据建议，在<code>hardware/interfaces/compatibility_matrices/compatibility_matrix.3.xml</code>中添加相同的内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;hal</span> <span class="na">format=</span><span class="s">&#34;hidl&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;name&gt;</span>sample.hardware.helloworld<span class="nt">&lt;/name&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;transport&gt;</span>hwbinder<span class="nt">&lt;/transport&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;interface&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;name&gt;</span>IHelloWorld<span class="nt">&lt;/name&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;instance&gt;</span>default<span class="nt">&lt;/instance&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/interface&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/hal&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>再次整编成功！</p>
<ul>
<li><i class="far fa-square fa-fw"></i> 后面需要详细了解一下<a href="https://source.android.google.cn/devices/architecture/vintf/comp-matrices" target="_blank" rel="noopener noreffer">兼容性矩阵</a>。</li>
</ul>
<h3 id="添加本地c测试">添加本地c++测试</h3>
<p>// 包名
PACKAGE=sample.hardware</p>
<p>// 软件名
<a href="mailto:NAME=$PACKAGE.helloworld@1.0" rel="">NAME=$PACKAGE.helloworld@1.0</a></p>
<p>// 软件包根目录
ROOT=vendor/sample/hardware/interfaces</p>
<p>// hidl实现文件存放的位置
LOC=$ROOT/helloworld/1.0/default</p>
<p>创建<code>$ROOT/1.0/test/Android.cpp</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cc_binary {
</span></span><span class="line"><span class="cl">    name: &#34;sample.hardware.helloworld_hidl_hal_test&#34;,
</span></span><span class="line"><span class="cl">    vendor: true,
</span></span><span class="line"><span class="cl">    srcs: [&#34;test.cpp&#34;],
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    shared_libs: [
</span></span><span class="line"><span class="cl">        &#34;libhidlbase&#34;,
</span></span><span class="line"><span class="cl">        &#34;libhidltransport&#34;,
</span></span><span class="line"><span class="cl">        &#34;liblog&#34;,
</span></span><span class="line"><span class="cl">        &#34;libutils&#34;,
</span></span><span class="line"><span class="cl">        &#34;libhardware&#34;,
</span></span><span class="line"><span class="cl">        &#34;sample.hardware.helloworld@1.0&#34;,
</span></span><span class="line"><span class="cl">    ],
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建<code>$ROOT/1.0/test/test.cpp</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#define LOG_TAG &#34;sample.hardware.helloworld_hidl_hal_test&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;android-base/logging.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;hidl/HidlTransportSupport.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;log/log.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sample/hardware/helloworld/1.0/IHelloWorld.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sample/hardware/helloworld/1.0/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="o">::</span><span class="n">android</span><span class="o">::</span><span class="n">sp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="o">::</span><span class="n">android</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">Return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="o">::</span><span class="n">android</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">Void</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="o">::</span><span class="n">sample</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">helloworld</span><span class="o">::</span><span class="n">V1_0</span><span class="o">::</span><span class="n">Event</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="o">::</span><span class="n">sample</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">helloworld</span><span class="o">::</span><span class="n">V1_0</span><span class="o">::</span><span class="n">IHelloWorld</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="o">::</span><span class="n">sample</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">helloworld</span><span class="o">::</span><span class="n">V1_0</span><span class="o">::</span><span class="n">IHelloWorldCallback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="o">::</span><span class="n">sample</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">helloworld</span><span class="o">::</span><span class="n">V1_0</span><span class="o">::</span><span class="n">Result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HelloWorldCallback</span> <span class="o">:</span> <span class="k">public</span> <span class="n">IHelloWorldCallback</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">HelloWorldCallback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">HelloWorldCallback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Return</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">onEvent</span><span class="p">(</span><span class="k">const</span> <span class="n">Event</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s %04x %04x %04x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">code</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">Void</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="cm">/* argc */</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="cm">/* argv */</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sp</span><span class="o">&lt;</span><span class="n">IHelloWorld</span><span class="o">&gt;</span> <span class="n">service</span> <span class="o">=</span> <span class="n">IHelloWorld</span><span class="o">::</span><span class="n">getService</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">service</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Failed to get service</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;initial</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">service</span><span class="o">-&gt;</span><span class="n">initial</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">service</span><span class="o">-&gt;</span><span class="n">getInt</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;getInt %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Result</span> <span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">-&gt;</span><span class="n">setInt</span><span class="p">(</span><span class="mi">888</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;setInt result=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">sp</span><span class="o">&lt;</span><span class="n">IHelloWorldCallback</span><span class="o">&gt;</span> <span class="n">callback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HelloWorldCallback</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;setCallback</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">service</span><span class="o">-&gt;</span><span class="n">setCallback</span><span class="p">(</span><span class="n">callback</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="编译出运行库">编译出运行库</h3>
<blockquote>
<p>因为我是小白，还不能充分理解，下面完全摘抄原作。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mmm vendor/sample/hardware/interfaces/helloworld/1.0/
</span></span></code></pre></td></tr></table>
</div>
</div><p>编译hal文件生成的中间代码位于out/soong/.intermediates/vendor/sample/hardware/interfaces/helloworld/1.0/:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">default
</span></span><span class="line"><span class="cl">sample.hardware.helloworld@1.0
</span></span><span class="line"><span class="cl">sample.hardware.helloworld@1.0-adapter
</span></span><span class="line"><span class="cl">sample.hardware.helloworld@1.0-adapter_genc++
</span></span><span class="line"><span class="cl">sample.hardware.helloworld@1.0-adapter-helper
</span></span><span class="line"><span class="cl">sample.hardware.helloworld@1.0-adapter-helper_genc++
</span></span><span class="line"><span class="cl">sample.hardware.helloworld@1.0-adapter-helper_genc++_headers
</span></span><span class="line"><span class="cl">sample.hardware.helloworld@1.0_genc++
</span></span><span class="line"><span class="cl">sample.hardware.helloworld@1.0_genc++_headers
</span></span><span class="line"><span class="cl">sample.hardware.helloworld-V1.0-java
</span></span><span class="line"><span class="cl">sample.hardware.helloworld-V1.0-java_gen_java
</span></span><span class="line"><span class="cl">test
</span></span></code></pre></td></tr></table>
</div>
</div><p>&ldquo;sample.hardware.helloworld@1.0_genc++&ldquo;目录里面可以发现hal文件转换成了C++源码 ,里面就包含Binder Bn端,Binder Bp端的代码.不用像非Project Treble项目那样需要自己写Binder Bn端,Binder Bp端的代码.体会到了谷歌的良苦用心。</p>
<p>编译最终会在out/target/product/$TARGET_PRODUCT/目录下面生成了以下文件:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/system/lib/sample.hardware.helloworld@1.0.so
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/system/lib/sample.hardware.helloworld@1.0-adapter-helper.so
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/system/lib64/sample.hardware.helloworld@1.0.so
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/system/lib64/sample.hardware.helloworld@1.0-adapter-helper.so
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/system/framework/sample.hardware.helloworld-V1.0-java.jar
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/system/framework/oat/arm/sample.hardware.helloworld-V1.0-java.odex
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/system/framework/oat/arm/sample.hardware.helloworld-V1.0-java.vdex
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/system/framework/oat/arm64/sample.hardware.helloworld-V1.0-java.odex
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/system/framework/oat/arm64/sample.hardware.helloworld-V1.0-java.vdex
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/vendor/lib/sample.hardware.helloworld@1.0-impl.so
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/vendor/lib/sample.hardware.helloworld@1.0.so
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/vendor/lib/sample.hardware.helloworld@1.0-adapter-helper.so
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/vendor/lib64/sample.hardware.helloworld@1.0-impl.so
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/vendor/lib64/sample.hardware.helloworld@1.0.so
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/vendor/lib64/sample.hardware.helloworld@1.0-adapter-helper.so
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/vendor/bin/hw/sample.hardware.helloworld@1.0-service
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/vendor/bin/sample.hardware.helloworld_hidl_hal_test
</span></span><span class="line"><span class="cl">out/target/product/$TARGET_PRODUCT/vendor/etc/init/sample.hardware.helloworld@1.0-service.rc
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="测试">测试</h2>
<h3 id="推送包到设备">推送包到设备</h3>
<p>将编译好的库和bin文件复制到设备中:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ adb root
</span></span><span class="line"><span class="cl">$ adb remount
</span></span><span class="line"><span class="cl">$ adb push  out/target/product/<span class="nv">$TARGET_PRODUCT</span>/vendor/lib64/sample.hardware.helloworld@1.0-impl.so /vendor/lib64/sample.hardware.helloworld@1.0-impl.so
</span></span><span class="line"><span class="cl">$ adb push  out/target/product/<span class="nv">$TARGET_PRODUCT</span>/vendor/lib64/sample.hardware.helloworld@1.0.so /vendor/lib64/sample.hardware.helloworld@1.0.so
</span></span><span class="line"><span class="cl">$ adb push  out/target/product/<span class="nv">$TARGET_PRODUCT</span>/vendor/bin/hw/sample.hardware.helloworld@1.0-service /vendor/bin/hw/sample.hardware.helloworld@1.0-service
</span></span><span class="line"><span class="cl">$ adb push  out/target/product/<span class="nv">$TARGET_PRODUCT</span>/vendor/bin/sample.hardware.helloworld_hidl_hal_test /vendor/bin/sample.hardware.helloworld_hidl_hal_test
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>我尝试直接整编，然后刷机，后续操作直接失败，说是找不到服务，然后进手机对应的目录，确实没有发现对应的库，暂时不知道是为什么。所以还是需要自己push到设备上。</p>
</blockquote>
<ul>
<li><i class="far fa-square fa-fw"></i> 整编刷机的问题</li>
</ul>
<h3 id="启动服务">启动服务</h3>
<p>在adb中启动服务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># ./vendor/bin/hw/sample.hardware.helloworld@1.0-service&amp;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意：</p>
<ul>
<li>指令最后的「&amp;」符号表示后台运行。</li>
<li>不加「&amp;」符号，输入指令后，shell会卡住不动，是正常的。</li>
<li>输入指令后，不会有任何输出，是正常的，想看输出，需要从logcat中查看。</li>
</ul>
<h3 id="启动测试">启动测试</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># sample.hardware.helloworld_hidl_hal_test</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>这里我又遇到问题：Cannot find entry in either framework or device manifest</p>
</blockquote>
<p>解决方式：在设备的<code>system/etc/vintf/manifest.xml</code>和<code>vendor/etc/vintf/manifest.xml</code>这两个文件中添加：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;hal</span> <span class="na">format=</span><span class="s">&#34;hidl&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;name&gt;</span>sample.hardware.helloworld<span class="nt">&lt;/name&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;transport&gt;</span>hwbinder<span class="nt">&lt;/transport&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;interface&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;name&gt;</span>IHelloWorld<span class="nt">&lt;/name&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;instance&gt;</span>default<span class="nt">&lt;/instance&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/interface&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/hal&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>再次尝试调用客户端成功！输出如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">initial
</span></span><span class="line"><span class="cl">getInt <span class="m">666</span>
</span></span><span class="line"><span class="cl">setInt <span class="nv">result</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">HelloWorldCallback
</span></span><span class="line"><span class="cl">setCallback
</span></span><span class="line"><span class="cl">onEvent <span class="m">0001</span> <span class="m">0001</span> <span class="m">0001</span>
</span></span><span class="line"><span class="cl">onEvent <span class="m">0002</span> <span class="m">0002</span> <span class="m">0002</span>
</span></span><span class="line"><span class="cl">onEvent <span class="m">0003</span> <span class="m">0003</span> <span class="m">0003</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="java层app调试">Java层App调试</h3>
<p>新建一个Android应用项目，然后将<code>out/soong/.intermediates/vendor/sample/hardware/interfaces/helloworld/1.0/sample.hardware.helloworld-V1.0-java/android_common/combined/sample.hardware.helloworld-V1.0-java.jar</code>复制到app的<code>libs</code>目录下，右键选择<code>add as library</code>，之后app的gradle:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-groovy" data-lang="groovy"><span class="line"><span class="cl"><span class="n">implementation</span> <span class="nf">files</span><span class="o">(</span><span class="s1">&#39;libs\\sample.hardware.helloworld-V1.0-java.jar&#39;</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>MainActivity.kt:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">package</span> <span class="nn">site.leasa.haltest</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">android.os.Bundle</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">android.os.RemoteException</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">android.util.Log</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">android.view.View</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">sample.hardware.helloworld.V1_0.Event</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">sample.hardware.helloworld.V1_0.IHelloWorld</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">sample.hardware.helloworld.V1_0.IHelloWorldCallback</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="n">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">lateinit</span> <span class="k">var</span> <span class="py">service</span><span class="p">:</span> <span class="n">IHelloWorld</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">val</span> <span class="py">TAG</span> <span class="p">=</span> <span class="s2">&#34;HAL_SERVICE_ACTIVITY&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_main</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">open</span> <span class="k">fun</span> <span class="nf">click</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">View</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="n">service</span> <span class="p">=</span> <span class="n">IHelloWorld</span><span class="p">.</span><span class="n">getService</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">service</span><span class="p">.</span><span class="n">initial</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">val</span> <span class="py">ret</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="n">service</span><span class="p">.</span><span class="n">getInt</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s2">&#34;getInt=</span><span class="si">$ret</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">service</span><span class="p">.</span><span class="n">setInt</span><span class="p">(</span><span class="m">888</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">service</span><span class="p">.</span><span class="n">setCallback</span><span class="p">(</span><span class="n">HelloWorldCallback</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">RemoteException</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Log</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s2">&#34;hal服务初始化失败: &#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HelloWorldCallback</span> <span class="p">:</span> <span class="n">IHelloWorldCallback</span><span class="p">.</span><span class="n">Stub</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">val</span> <span class="py">TAG</span> <span class="p">=</span> <span class="s2">&#34;HAL_SERVICE_Callback&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onEvent</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s2">&#34;onEvent type=&#34;</span> <span class="p">+</span> <span class="n">event</span><span class="p">.</span><span class="n">type</span> <span class="p">+</span> <span class="s2">&#34;, code=&#34;</span> <span class="p">+</span> <span class="n">event</span><span class="p">.</span><span class="n">code</span> <span class="p">+</span> <span class="s2">&#34;, value=&#34;</span> <span class="p">+</span> <span class="n">event</span><span class="p">.</span><span class="k">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后控制台进adb shell,启动服务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># ./vendor/bin/hw/sample.hardware.helloworld@1.0-service&amp;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>启动App,点一下按钮出发<code>click方法</code>后，会报错：<code>NoSuchElement</code>，就是找不到我们的hal服务，之所以出现这个问题，是因为我们没有配置<code>selinux</code>的标签，这玩意太麻烦了，放后面学习，现在先关掉selinux：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">adb shell setenforce <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后重启启动app,点击按钮，logcat控制台输出如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">initial
</span></span><span class="line"><span class="cl">getInt <span class="m">666</span>
</span></span><span class="line"><span class="cl">setInt <span class="nv">result</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">HelloWorldCallback
</span></span><span class="line"><span class="cl">setCallback
</span></span><span class="line"><span class="cl">onEvent <span class="m">0001</span> <span class="m">0001</span> <span class="m">0001</span>
</span></span><span class="line"><span class="cl">onEvent <span class="m">0002</span> <span class="m">0002</span> <span class="m">0002</span>
</span></span><span class="line"><span class="cl">onEvent <span class="m">0003</span> <span class="m">0003</span> <span class="m">0003</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="后记">后记</h2>
<p>对于hal,我目前只是最粗浅的能够编译并运转，里面很多机制还不了解，后续会慢慢梳理好，补充道本文，这里还是特别感谢<a href="https://www.codenong.com/cs109234795/" target="_blank" rel="noopener noreffer">这篇文章</a>，对我的学习产生莫大帮助！</p>
<p>安卓系统是个很复杂的东西，当然HAL层启到承上启下的桥梁作用，对于我这个新手来说上手难度较大，本文的东西也是断断续续用了很长时间，磕磕绊绊解决了很多问题才产生的结果，可以说不容易，很庆幸，同时也见识到了操作系统层面的复杂精深，对知识广度有很高的要求。攻克下来，一马平川！还是那句话：If i want, i can do it!</p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-08-03</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="#" onclick="return false;" title="分享到 Twitter" data-sharer="twitter" data-url="https://vee-zhang.github.io/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E8%87%AA%E5%AE%9A%E4%B9%89hal%E5%B1%82/" data-title="手把手教你自定义HAL层"><i class="fab fa-twitter fa-fw"></i></a><a href="#" onclick="return false;" title="分享到 Facebook" data-sharer="facebook" data-url="https://vee-zhang.github.io/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E8%87%AA%E5%AE%9A%E4%B9%89hal%E5%B1%82/"><i class="fab fa-facebook-square fa-fw"></i></a><a href="#" onclick="return false;" title="分享到 Instapaper" data-sharer="instapaper" data-url="https://vee-zhang.github.io/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E8%87%AA%E5%AE%9A%E4%B9%89hal%E5%B1%82/" data-title="手把手教你自定义HAL层" data-description=""><i data-svg-src="/lib/simple-icons/icons/instapaper.min.svg"></i></a><a href="#" onclick="return false;" title="分享到 微博" data-sharer="weibo" data-url="https://vee-zhang.github.io/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E8%87%AA%E5%AE%9A%E4%B9%89hal%E5%B1%82/" data-title="手把手教你自定义HAL层" data-ralateuid="xxxx"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="#" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/%E7%BC%96%E8%AF%91%E6%8A%80%E5%B7%A7/" class="prev" rel="prev" title="编译技巧"><i class="fas fa-angle-left fa-fw"></i>编译技巧</a>
            <a href="/ubuntu22.04%E4%B8%8A%E4%B8%8D%E8%83%BD%E4%BD%BF%E7%94%A8adb/" class="next" rel="next" title="ubuntu22.04上不能使用adb">ubuntu22.04上不能使用adb<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="twikoo"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://twikoo.js.org/">Twikoo</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.104.3">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreffer" title="DoIt 0.2.10"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/vee-zhang" target="_blank" rel="noopener noreferrer">Vee Zhang</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div><script>
                    if('serviceWorker' in navigator) {
                        navigator.serviceWorker
                            .register('/sw.min.js', { scope: '/' })
                            .then(function(registration) {
                                
                            });
                
                        navigator.serviceWorker
                            .ready
                            .then(function(registration) {
                                
                            });
                    }
                </script></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/topbar/topbar.min.js"></script><script type="text/javascript" src="/lib/pjax/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js"></script></div>

<div class="pjax-assets"><script type="text/javascript" src="/lib/twikoo/twikoo.all.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"twikoo":{"el":"#twikoo","envId":"https://doit-docs-comment-twikoo.vercel.app/","lang":"zh-cn"}},"search":{"algoliaAppID":"5YGRNRQK1G","algoliaIndex":"zh_cn_index","algoliaSearchKey":"0ff6874805de24b84aa1d5ebccad56cd","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"sharerjs":true};</script></div>
</body>

</html>