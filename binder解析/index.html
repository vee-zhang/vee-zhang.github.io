<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=zh-CN lang=zh-cn><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Binder解析 &#183; Vee's space</title><meta name=description content><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/print.css media=print><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/poole.css><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/syntax.css><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><link href=https://vee-zhang.github.io/binder%E8%A7%A3%E6%9E%90/index.md rel=alternate type=text/plain title="Vee's space"></head><body><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://vee-zhang.github.io><h1>Vee's space</h1></a><p class=lead>关于 DoIt 主题</p></div><nav><ul class=sidebar-nav><li><a href=https://vee-zhang.github.io>Home</a></li><li><a href=/posts/>所有文章</a></li><li><a href=/tags/>标签</a></li><li><a href=/categories/>分类</a></li><li><a href=/series/>系列</a></li><li><a href=/about/>关于</a></li></ul></nav><p>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</p></div></aside><main class="content container"><div class=post><h1>Binder解析</h1><time datetime=2021-03-12T11:06:25Z class=post-date>Fri, Mar 12, 2021</time><h2 id=binder是什么>Binder是什么</h2><ul><li>进程间通讯机制</li><li>系统驱动</li><li>Binder.java跨进程能力</li></ul><h2 id=为何要多进程>为何要多进程</h2><ul><li>申请更多内存</li><li>安全性隔离</li></ul><h2 id=binder的优势>Binder的优势</h2><table><thead><tr><th>机制</th><th>性能</th><th>特点</th><th>安全性</th></tr></thead><tbody><tr><td>Binder</td><td>一次拷贝</td><td>CS架构易用</td><td>为每个App分配UID，支持实名和匿名</td></tr><tr><td>共享内存</td><td>零拷贝</td><td>控制复杂</td><td>差</td></tr><tr><td>socket</td><td>双拷贝</td><td>CS架构，传输率低开销大</td><td>差</td></tr><tr><td>信号量</td><td>双拷贝</td><td>缓存-转发</td><td>差</td></tr><tr><td>管道</td><td>双拷贝</td><td>缓存-转发</td><td>差</td></tr></tbody></table><h2 id=进程之间如何通讯>进程之间如何通讯</h2><h3 id=用户空间与内核空间>用户空间与内核空间</h3><p><img src=%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E5%88%87%E5%88%B0%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4.jpg alt></p><p>操作系统内部分为<strong>用户空间与内核空间</strong>。</p><p>从图中看，应用的进程处于用户空间，系统中同时存在多个应用相当于同时存在多个用户空间。而所有的用户空间都对应同一个内核空间。用户空间相互之间不共享，但是内核空间是共享的。</p><p>所有<strong>系统资源</strong>的管理都是在内核空间进行的，那我们应用程序需要访问磁盘，读取网卡的数据，新建一个线程都需要通过系统调用接口，完成从用户态到内存态的切换。</p><p><strong>当一个任务（进程）执行系统调用而陷入内核代码中执行时，称进程处于内核运行态（内核态）。</strong></p><blockquote><p>比如我们 Java 中需要新建一个线程，new Thread( Runnable &mldr;) 之后调用 start() 方法时, 看Hotspot Linux 的JVM 源码实现，最终是调pthread_create 系统方法来创建的线程，这里会从用户态切换到内核态完成系统资源的分配，线程的创建。</p></blockquote><p>那么不共享的用户空间之间怎么进行通信呢？传统的linux的IPC是使用<strong>双拷贝</strong>进行的，即不同用户空间中，不能简单的通过引用指针传递数据，而是必须在内核空间中调用<code>copy_from_user</code>先把数据拷贝到内核空间，再调用<code>copy_to_user</code>把数据拷贝到client所在的用户空间B。</p><h2 id=binder通讯机制>Binder通讯机制</h2><p><img src=binder%E6%B5%81%E7%A8%8B.png alt></p><p>这就很像我们在家里访问百度，我们先从浏览器输入百度的域名回车，然后请求会先到达附近的DNS，DNS负责把域名解析成对应的IP地址，然后转发请求到这个IP的服务器上。</p><ul><li>server，负责创建Binder实体，并且把Binder实体以名称的形式字注册到ServiceManager；</li><li>ServiceManager，是一个独立的进程，提供Binder的注册和查询功能；<code>ServiceManager自己其实也是个server，自己带有一个特殊的Binder实体（0号），而其他进程都可以看作是client</code>。当我们的server创建Binder实体后，通过这个特殊的binder通信实现注册。而client也通过这个特殊的Binder，去查询目标Binder的名字，查到就返回Binder的引用。</li><li>Binder驱动，真正的通信是由Binder驱动来完成的，提供了用户空间到内核空间切换（数据拷贝）线程管理，PID、UID管理等功能。</li></ul><p>这里要注意的是，<code>SM位于用户空间，而BinderDriver位于内核空间</code>。</p><h3 id=binderdriver的作用>BinderDriver的作用</h3><p>主要是用来创建Binder实体，并且控制实体的访问，包括多线程对实体的访问安全，Client的访问权限，进程的中断等待等。</p><p>当有进程通过<code>BINDERSETCONTEXT_MGR </code>命令把自己注册成为ServiceManager时，会通过BinderDriver创建一个默认的Binder实体，并置于0号位，并且后面的新创建的Client都默认持有这个0号位的Binder实体（zygote不断fork自己，所以都带有0号位）。</p><h3 id=servicemanager的宏观作用>ServiceManager的宏观作用</h3><p>SM是一个独立的<strong>守护进程</strong>，是Android系统中各个服务的管理者。系统中的所有server都通过名称-引用的方式在SM中注册，而client全都要通过SM查询服务名找到目标server之后再使用server提供的功能。</p><h3 id=binder机制的宏观作用>Binder机制的宏观作用</h3><p>从上面我们看SM的作用，就知道整个Binder机制的宏观作用，他就是Android系统的心脏，负责驱动Android系统的所有功能。</p><h3 id=binder的通信过程>Binder的通信过程</h3><p><img src=binder%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6.png alt></p><blockquote><p>ioctl函数是linux系统中驱动程序对外提供的调用接口。</p></blockquote><h4 id=注册过程>注册过程</h4><ol><li>Server进程启动之后，通过ioctl函数向Driver发起请求，并指明需要0号位binder引用对应的进程来处理；</li><li>驱动收到请求后，通过SM内部的红黑树查询是否注册过binder实体，由于0号位已注册过了，就不需要再创建实体和添加引用了，直接把Binder实体转发给对应的进程，在这里就是SM进程；</li><li>SM收到请求之后，将Server的<strong>binder引用</strong>添加到内部的单链表中，完成注册；</li></ol><h4 id=通信过程>通信过程</h4><ol><li>client通过ioctl函数向Driver发起请求（包含binder名称）；</li><li>Driver将请求转发给SM；</li><li>SM在引用单链表中根据名称查询Server的引用；</li><li>通过Driver返回Binder的引用；</li><li>Client收到引用之后，创建一个Server的代理；</li><li>Client调用代理的接口，通过Driver与真正的Server进行交互。</li></ol><h4 id=总结>总结</h4><p>整个通信过程，其实就是创建远程代理与调用远程代理的过程。</p><h2 id=aidl>AIDL</h2><h3 id=定义>定义</h3><p>AIDL的全称是：Android接口定义语言(即 Android Interface Definition Language)，他定义的只不过是一套模板，实际起作用的是AS通过解释这个模板自动生成的<code>android.os.IInterface</code>的子类接口。作用是依靠<code>Service</code>中转，通过Binder机制来做IPC。</p><h3 id=数据类型>数据类型</h3><p>AIDL支持的数据类型：</p><ul><li>byte</li><li>char</li><li>short</li><li>int</li><li>long</li><li>float</li><li>double</li><li>boolean</li><li>Parcelable</li><li>List</li><li>Map</li></ul><h3 id=定向tag>定向Tag</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>BookController</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Book</span><span class=o>&gt;</span> <span class=nf>getBookList</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>addBookInOut</span><span class=o>(</span><span class=n>inout</span> <span class=n>Book</span> <span class=n>book</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>addBookIn</span><span class=o>(</span><span class=n>in</span> <span class=n>Book</span> <span class=n>book</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>addBookOut</span><span class=o>(</span><span class=n>out</span> <span class=n>Book</span> <span class=n>book</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>in 数据只能由客户端流向服务端</li><li>out 数据只能由服务端流向客户端</li><li>inout 数据可在服务端与客户端之间双向流通</li></ul><p>如果AIDL方法接口的参数值类型是：基本数据类型、String、CharSequence或者其他AIDL文件定义的方法接口，那么这些参数值的定向 Tag 默认是且只能是 in，所以除了这些类型外，其他参数值都需要明确标注使用哪种定向Tag。</p><blockquote><p>引自https://www.jianshu.com/p/29999c1a93cd</p></blockquote><h3 id=源码>源码</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//包名与项目包名一致
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nn>com.vee.aidltest</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>*   自动生成的接口
</span></span></span><span class=line><span class=cl><span class=cm>**/</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>IMyAidlInterface</span> <span class=kd>extends</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IInterface</span><span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    *    我们自己声明的业务函数
</span></span></span><span class=line><span class=cl><span class=cm>    **/</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=nf>getName</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>RemoteException</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    * 本接口的默认实现，其中业务方法`getName`返回null;
</span></span></span><span class=line><span class=cl><span class=cm>    **/</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Default</span> <span class=kd>implements</span> <span class=n>com</span><span class=o>.</span><span class=na>vee</span><span class=o>.</span><span class=na>aidltest</span><span class=o>.</span><span class=na>IMyAidlInterface</span><span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    *   静态内部类，继承自`android.os.Binder.Stub`类型，也遵循AIDL接口
</span></span></span><span class=line><span class=cl><span class=cm>    **/</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>Stub</span> <span class=kd>extends</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Binder</span> <span class=kd>implements</span> <span class=n>com</span><span class=o>.</span><span class=na>vee</span><span class=o>.</span><span class=na>aidltest</span><span class=o>.</span><span class=na>IMyAidlInterface</span><span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>        * 用来标记当前Binder，所以采用全类名表示
</span></span></span><span class=line><span class=cl><span class=cm>        **/</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=n>DESCRIPTOR</span> <span class=o>=</span> <span class=s>&#34;com.vee.aidltest.IMyAidlInterface&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>        *   构造方法中调用对象方法。
</span></span></span><span class=line><span class=cl><span class=cm>        **/</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=nf>Stub</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>attachInterface</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>        *  用于将服务端的Binder对象转换成客户端所需的AIDL接口类型的对象，这种转换过* 程是区分进程的，如果客户端和服务端位于同一进程，那么此方法返回的就是服务端*的Stub对象本身，否则返回的是系统封装后的Stub.proxy对象 
</span></span></span><span class=line><span class=cl><span class=cm>        */</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=n>com</span><span class=o>.</span><span class=na>vee</span><span class=o>.</span><span class=na>aidltest</span><span class=o>.</span><span class=na>IMyAidlInterface</span> <span class=nf>asInterface</span><span class=o>(</span><span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=n>obj</span><span class=o>){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>((</span><span class=n>obj</span><span class=o>==</span><span class=kc>null</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IInterface</span> <span class=n>iin</span> <span class=o>=</span> <span class=n>obj</span><span class=o>.</span><span class=na>queryLocalInterface</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(((</span><span class=n>iin</span><span class=o>!=</span><span class=kc>null</span><span class=o>)&amp;&amp;(</span><span class=n>iin</span> <span class=k>instanceof</span> <span class=n>com</span><span class=o>.</span><span class=na>vee</span><span class=o>.</span><span class=na>aidltest</span><span class=o>.</span><span class=na>IMyAidlInterface</span><span class=o>)))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=o>((</span><span class=n>com</span><span class=o>.</span><span class=na>vee</span><span class=o>.</span><span class=na>aidltest</span><span class=o>.</span><span class=na>IMyAidlInterface</span><span class=o>)</span><span class=n>iin</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>com</span><span class=o>.</span><span class=na>vee</span><span class=o>.</span><span class=na>aidltest</span><span class=o>.</span><span class=na>IMyAidlInterface</span><span class=o>.</span><span class=na>Stub</span><span class=o>.</span><span class=na>Proxy</span><span class=o>(</span><span class=n>obj</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>        * 返回当前Binder对象
</span></span></span><span class=line><span class=cl><span class=cm>        **/</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span> <span class=kd>public</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=nf>asBinder</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span> <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>onTransact</span><span class=o>(</span><span class=kt>int</span> <span class=n>code</span><span class=o>,</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>data</span><span class=o>,</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>reply</span><span class=o>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>RemoteException</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=n>descriptor</span> <span class=o>=</span> <span class=n>DESCRIPTOR</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=o>(</span><span class=n>code</span><span class=o>){</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=n>INTERFACE_TRANSACTION</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>reply</span><span class=o>.</span><span class=na>writeString</span><span class=o>(</span><span class=n>descriptor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=n>TRANSACTION_getName</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=o>.</span><span class=na>enforceInterface</span><span class=o>(</span><span class=n>descriptor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=n>_arg0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>_arg0</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=na>readString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=n>_result</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>getName</span><span class=o>(</span><span class=n>_arg0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>reply</span><span class=o>.</span><span class=na>writeNoException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>reply</span><span class=o>.</span><span class=na>writeString</span><span class=o>(</span><span class=n>_result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kd>super</span><span class=o>.</span><span class=na>onTransact</span><span class=o>(</span><span class=n>code</span><span class=o>,</span> <span class=n>data</span><span class=o>,</span> <span class=n>reply</span><span class=o>,</span> <span class=n>flags</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>        *   自动生成的静态代理，在客户端回调
</span></span></span><span class=line><span class=cl><span class=cm>        **/</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Proxy</span> <span class=kd>implements</span> <span class=n>com</span><span class=o>.</span><span class=na>vee</span><span class=o>.</span><span class=na>aidltest</span><span class=o>.</span><span class=na>IMyAidlInterface</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=n>mRemote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>Proxy</span><span class=o>(</span><span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=n>remote</span><span class=o>){</span>
</span></span><span class=line><span class=cl>            <span class=n>mRemote</span> <span class=o>=</span> <span class=n>remote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span> <span class=kd>public</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinder</span> <span class=nf>asBinder</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>mRemote</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=nf>getInterfaceDescriptor</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>DESCRIPTOR</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nd>@Override</span> <span class=kd>public</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=nf>getName</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>RemoteException</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>_data</span> <span class=o>=</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span> <span class=n>_reply</span> <span class=o>=</span> <span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>Parcel</span><span class=o>.</span><span class=na>obtain</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>String</span> <span class=n>_result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>_data</span><span class=o>.</span><span class=na>writeInterfaceToken</span><span class=o>(</span><span class=n>DESCRIPTOR</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>boolean</span> <span class=n>_status</span> <span class=o>=</span> <span class=n>mRemote</span><span class=o>.</span><span class=na>transact</span><span class=o>(</span><span class=n>Stub</span><span class=o>.</span><span class=na>TRANSACTION_getName</span><span class=o>,</span> <span class=n>_data</span><span class=o>,</span> <span class=n>_reply</span><span class=o>,</span> <span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(!</span><span class=n>_status</span> <span class=o>&amp;&amp;</span> <span class=n>getDefaultImpl</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>getDefaultImpl</span><span class=o>().</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>_reply</span><span class=o>.</span><span class=na>readException</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>_result</span> <span class=o>=</span> <span class=n>_reply</span><span class=o>.</span><span class=na>readString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>_reply</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>_data</span><span class=o>.</span><span class=na>recycle</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>_result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=n>com</span><span class=o>.</span><span class=na>vee</span><span class=o>.</span><span class=na>aidltest</span><span class=o>.</span><span class=na>IMyAidlInterface</span> <span class=n>sDefaultImpl</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>        *   用来标记我们自己定义的方法，前缀确定
</span></span></span><span class=line><span class=cl><span class=cm>        **/</span>
</span></span><span class=line><span class=cl>        <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>TRANSACTION_getName</span> <span class=o>=</span> <span class=o>(</span><span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinderFIRST_CALL_TRANSACTION</span> <span class=o>+</span> <span class=mi>0</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>        * 当处于客户端时调用，这里就是生成代理
</span></span></span><span class=line><span class=cl><span class=cm>        **/</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>setDefaultImpl</span><span class=o>(</span><span class=n>com</span><span class=o>.</span><span class=na>vee</span><span class=o>.</span><span class=na>aidltest</span><span class=o>.</span><span class=na>IMyAidlInterface</span> <span class=n>impl</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>Stub</span><span class=o>.</span><span class=na>Proxy</span><span class=o>.</span><span class=na>sDefaultImpl</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;setDefaultImpl() called twice&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>impl</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Stub</span><span class=o>.</span><span class=na>Proxy</span><span class=o>.</span><span class=na>sDefaultImpl</span> <span class=o>=</span> <span class=n>impl</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>        *   当处于客户端时用来获取代理对象
</span></span></span><span class=line><span class=cl><span class=cm>        **/</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=n>com</span><span class=o>.</span><span class=na>vee</span><span class=o>.</span><span class=na>aidltest</span><span class=o>.</span><span class=na>IMyAidlInterface</span> <span class=nf>getDefaultImpl</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Stub</span><span class=o>.</span><span class=na>Proxy</span><span class=o>.</span><span class=na>sDefaultImpl</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=descriptor>DESCRIPTOR</h4><p>Binder的唯一标识，一般用当前Binder的类名表示，比如本例中的<code>com.ryg.chapter_2.aidl.IBookManager</code>。</p><h4 id=asinterfaceandroidosibinder-obj>asInterface(android.os.IBinder obj)</h4><p>用于将服务端的Binder对象转换成客户端所需的AIDL接口类型的对象，这种转换过程是区分进程的，如果客户端和服务端位于同一进程，那么此方法返回的就是服务端的Stub对象本身，否则返回的是系统封装后的Stub.proxy对象。</p><h4 id=asbinder>asBinder</h4><p>此方法用于返回当前Binder对象。</p><h4 id=ontransact重要>onTransact:重要</h4><p>这个方法运行在服务端中的Binder线程池中，当客户端发起跨进程请求时，远程请求会通过系统底层封装后交由此方法来处理。该方法的原型为<code>public Boolean onTransact(int code,android.os.Parcel data,android.os.Parcel reply,int flags)</code>。服务端先通过switch(code)可以判断出客户端所请求的是具体哪个方法。还记得这个方法标记吗：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>*   用来标记我们自己定义的方法，前缀确定
</span></span></span><span class=line><span class=cl><span class=cm>**/</span>
</span></span><span class=line><span class=cl><span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>TRANSACTION_getName</span> <span class=o>=</span> <span class=o>(</span><span class=n>android</span><span class=o>.</span><span class=na>os</span><span class=o>.</span><span class=na>IBinderFIRST_CALL_TRANSACTION</span> <span class=o>+</span> <span class=mi>0</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>接着从data中取出目标方法所需的参数（如果目标方法有参数的话），data是个Parcel，所以这里是从二进制流中去读。</p><p>然后执行目标方法。当目标方法执行完毕后，就向reply中写入返回值（如果目标方法有返回值的话），而有异常的话也会写进reply。reply也是个Parcel，所以这里是把数据写进了流。</p><p>onTransact方法的执行过程就是这样的。需要注意的是，如果此方法返回false，那么客户端的请求会失败，因此我们可以利用这个特性来做权限验证，毕竟我们也不希望随便一个进程都能远程调用我们的服务。</p><h4 id=proxygetname>Proxy.getName</h4><p>这个方法运行在客户端。</p><p>首先从Parcel的缓存池中拿到两个parcel对象分别是<code>_data</code>和<code>_reply</code>，然后把参数<code>name</code>写进<code>_data</code>，</p><p>然后调用<code>mRemote</code>对象的<code>transact()</code>方法发起RPC请求，同时挂起当前线程。</p><p>这里调用<code>transact()</code>时传递了<code>Stub.TRANSACTION_getName</code>，RPC到服务端时也是依靠方法ID去调用方法的。</p><p>然后服务端的<code>transact</code>方法会回调，知道RPC过程结束返回后，当前线程继续执行，并从_reply中读取服务端<code>transact</code>方法的返回值或者异常。</p><p>最后先回收刚刚拿到的Parcel，然后返回<code>_result</code>给客户端。</p><p>这里的<code>mRemote</code>是个<code>IBinder</code>类型，但是后者其实是<code>Binder</code>的接口，那么可以断定<code>mRemote</code>其实就是个<code>Binder</code>。</p><h2 id=提取一下重点>提取一下重点</h2><p>两个端：</p><ul><li>server</li><li>client</li></ul><p>两个标记：</p><ul><li>DESCRIPTOR：当前Binder的唯一标志</li><li>TRANSACTION_getName：方法的唯一标志</li></ul><p>两个类型：</p><ul><li>abstract class <code>Stub</code> extends android.os.Binder implements IMyAidlInterface</li><li>static class <code>Proxy</code> implements IMyAidlInterface</li></ul><p>5个方法：</p><ul><li>asInterface</li><li>asBinder</li><li>业务方法</li><li>transact</li><li>onTransact</li></ul><h2 id=梳理流程>梳理流程</h2><p><img src=binder%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6.png alt=binder通信机制></p><ol><li>服务端向<code>ServiceManager</code>注册Binder。</li><li>客户端(通过<code>bindService()</code>回调)拿到Binder，调用<code>Stub.asInterface(binderObj)</code>。在这个方法中通过<code>DESCRIPTOR</code>标志在<code>ServiceManager</code>中去找Binder，如果找到直接返回，找不到就创建这个binder的Proxy对象。Proxy对象中包含被代理的业务方法。</li><li>客户端调用Proxy中代理的业务方法，此时创建两个Parcel：<code>_data</code>和<code>_reply</code>。然后调用代理中的binder的<code>transact()</code>方法，传入<code>TRANSACTION_getName</code>方法标记、_data、_reply，这样就执行了服务端binder中的业务逻辑方法，此时线程挂起。</li><li>客户端调用服务端的<code>transact()</code>方法会回调服务端的<code>onTransact()</code>方法。在这个方法中会根据<code>TRANSACTION_getName</code>判断应该调用哪个业务逻辑方法，然后挂起线程，执行对应的业务逻辑方法，最后在reply中写入异常或结果。</li><li>客户端继续执行<code>transact()</code>方法，从_reply中读取异常或返回值，再继续线程，最后回收_data和_reply并返回_reply中读到的结果。</li></ol><h2 id=binder连接池>Binder连接池</h2></div></main></body></html>