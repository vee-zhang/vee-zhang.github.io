---
title: CASåŸç†å’Œé—®é¢˜
date: 2021-01-07 16:30:36
tags: [Java]
---

## æ­»é”

æ­»é”æ˜¯æŒ‡å¤šä¸ªçš„çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äºç«äº‰èµ„æºæˆ–è€…ç”±äºæ‰¹æ¬¡é€šä¿¡è€Œé€ æˆçš„ä¸€ç§é˜»å¡ç°è±¡ã€‚è‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œä»–ä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚

## æ‚²è§‚é”ä¸ä¹è§‚é”

- æ‚²è§‚é”: å‡å®šä¼šå‘ç”Ÿå¹¶å‘å†²çªï¼Œå³å…±äº«èµ„æºä¼šè¢«æŸä¸ªçº¿ç¨‹æ›´æ”¹ã€‚æ‰€ä»¥å½“æŸä¸ªçº¿ç¨‹è·å–å…±äº«èµ„æºæ—¶ï¼Œä¼šé˜»æ­¢åˆ«çš„çº¿ç¨‹è·å–å…±äº«èµ„æºã€‚ä¹Ÿç§°**ç‹¬å é”æˆ–è€…äº’æ–¥é”**ï¼Œä¾‹å¦‚javaä¸­çš„synchronizedåŒæ­¥é”ã€‚
- ä¹è§‚é”: å‡è®¾ä¸ä¼šå‘ç”Ÿå¹¶å‘å†²çªï¼Œåªæœ‰åœ¨æœ€åæ›´æ–°å…±äº«èµ„æºçš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´æœ‰æ²¡æœ‰åˆ«çš„çº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå…±äº«èµ„æºã€‚å¦‚æœå‘ç”Ÿå†²çªå°±**é‡è¯•**ï¼Œç›´åˆ°æ²¡æœ‰å†²çªï¼Œæ›´æ–°æˆåŠŸã€‚CASå°±æ˜¯ä¸€ç§ä¹è§‚é”å®ç°æ–¹å¼ã€‚

ç”±äºä¹è§‚é”ä¸ä¼šé˜»å¡å…¶ä»–çº¿ç¨‹ï¼Œæ‰€ä»¥ç›¸å¯¹ç›¸ç‡æ›´é«˜ã€‚

## CAS

### å®šä¹‰ compare and swap æ¯”è¾ƒå¹¶ä¸”äº¤æ¢

JVMçš„CASåŒæ—¶åŒ…å«äº†CPUçš„CASæŒ‡ä»¤å’Œè‡ªé€‰æ“ä½œã€‚

CPUçš„CASæŒ‡ä»¤æ ¸å¿ƒæ˜¯ä¸‰ä¸ªå€¼ä¹‹é—´çš„æ¯”è¾ƒå’Œäº¤æ¢ï¼š

- å½“å‰å†…å­˜å€¼(O)
- é¢„æœŸåŸæ¥çš„å€¼(C)
- æœŸå¾…æ›´æ–°çš„å€¼(U)

æ¯”è¾ƒæ–¹å¼ï¼š

å¦‚æœå†…å­˜ä½ç½®Oçš„å€¼ä¸é¢„æœŸåŸå€¼Cç›¸åŒ¹é…ï¼Œé‚£ä¹ˆå¤„ç†å™¨ä¼šè‡ªåŠ¨å°†è¯¥ä½ç½®å€¼æ›´æ–°ä¸ºæ–°å€¼,è¿”å›trueã€‚å¦åˆ™å¤„ç†å™¨ä¸åšä»»ä½•æ“ä½œï¼Œè¿”å›falseã€‚

JVMæ¥æ”¶åˆ°falseåä¼šè‡ªæ—‹æ“ä½œï¼Œç›´åˆ°æ”¶åˆ°trueä¸ºæ­¢ã€‚

eg:


å‡è®¾å½“å‰æœ‰ä¸¤ä¸ªçº¿ç¨‹t1å’Œt2å¹¶å‘æ“ä½œOï¼ˆOå¤„äºå†…å­˜ä¸­ï¼‰ï¼Œå½“t1æ‹¿åˆ°é”å‡†å¤‡å¼€å§‹å˜æ›´Oæ—¶ï¼Œt1ä¼šå…ˆæŠŠOæ‹·è´å‡ºä¸€ä¸ªå®ƒè‡ªå·±çš„çº¿ç¨‹å‰¯æœ¬C(å¤„äºCPUç¼“å­˜ä¸­)ï¼Œç„¶åå¯¹å‰¯æœ¬åšå¯¹åº”çš„æ“ä½œäº§ç”ŸUï¼Œä¹‹åå†ç”¨Cå»è·Ÿå†…å­˜ä¸­çš„Oåšæ¯”è¾ƒï¼Œå¦‚æœC=Oï¼Œè¯´æ˜å†…å­˜ä¸­çš„Oæ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹å˜æ›´ï¼Œé‚£ä¹ˆå°±æŠŠUåˆ·å†™è¿›å†…å­˜æ›¿æ¢æ‰Oï¼Œå¹¶ä¸”è¿”å›trueï¼›å¦‚æœC!=Oï¼Œå°±ç›´æ¥è¿”å›falseã€‚

JVMæ¥æ”¶åˆ°falseåï¼Œå°±ä¼šä»å¤´å†æ¥ä¸€éï¼Œä¹Ÿå°±æ˜¯è‡ªæ—‹ã€‚ä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤æ—¶å†…å­˜ä¸­çš„Oå·²ç»è¢«t2æ›´æ”¹ä¸ºO+äº†,æ‰€ä»¥t1ä¼šæŠŠO+ä½œä¸ºå½“å‰å€¼åˆ›å»ºå‰¯æœ¬C+,æ‰§è¡Œæ“ä½œåäº§ç”ŸU+,ç„¶åç”¨C+å†å»è·Ÿå†…å­˜ä¸­çš„å€¼å¯¹æ¯”ã€‚å¦‚æ­¤å¾ªç¯å¾€å¤ï¼Œç›´åˆ°CPUè¿”å›trueä¸ºæ­¢ã€‚

å…¸å‹å°±æ˜¯JUCå¹¶å‘æ¡†æ¶ä¸‹çš„atomicåŸå­ç±»å‹ã€‚

æ³¨æ„ï¼šCASæœ¬èº«ä¸å¾ªç¯ï¼Œå¾ªç¯ä¹Ÿå°±æ˜¯è‡ªæ—‹æ˜¯ç”±JVMå®ç°çš„ã€‚

### CSçš„ä¸‰å¤§é—®é¢˜

- ABAé—®é¢˜
- å¼€é”€é—®é¢˜
- åªèƒ½ä¿è¯ä¸€ä¸ªå†…å­˜å˜é‡çš„åŸå­æ“ä½œ

#### ABAé—®é¢˜

é—®é¢˜æè¿°ï¼šçº¿ç¨‹t1å°†å®ƒçš„å€¼ä»Aå˜ä¸ºBï¼Œå†ä»Bå˜ä¸ºAã€‚åŒæ—¶æœ‰çº¿ç¨‹t2è¦å°†å€¼ä»Aå˜ä¸ºCã€‚ä½†CASæ£€æŸ¥çš„æ—¶å€™ä¼šå‘ç°æ²¡æœ‰æ”¹å˜ï¼Œä½†æ˜¯å®è´¨ä¸Šå®ƒå·²ç»å‘ç”Ÿäº†æ”¹å˜ ã€‚å¯èƒ½ä¼šé€ æˆæ•°æ®çš„ç¼ºå¤±ã€‚

##### é—®é¢˜æè¿°ï¼š

t1å’Œt2åŒæ—¶æ“ä½œAï¼Œt1è¦æŠŠAæ”¹ä¸ºBå†æ”¹å›Aï¼Œå¹¶ä¸”t1æ¯”t2é€Ÿåº¦å¿«çš„å¤šï¼Œå¯¼è‡´t2è¦æŠŠAæ”¹ä¸ºCæ—¶ï¼Œæ¯”è¾ƒçš„ç»“æœä¼šè®¤ä¸ºAæ²¡æœ‰è¢«æ”¹å˜è¿‡ï¼Œä¼šç›´æ¥è¿›è¡Œæ›¿æ¢ï¼Œå¯¼è‡´äº†æ•°æ®ä¸¢å¤±ã€‚

##### eg

æœ‰ä¸€æ¡å•å‘é“¾A->Bï¼Œæˆ‘ä»¬æƒ³é€šè¿‡å¹¶å‘æŠŠå®ƒå˜ä¸ºB->C->Dã€‚

çº¿ç¨‹t1è´Ÿè´£æŠŠAç§»é™¤ï¼Œè®©æ ˆé¡¶å˜ä¸ºBï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è¿›è¡ŒCASã€‚

æ­¤æ—¶ä¸€ä¸ªéå¸¸å¿«çš„çº¿ç¨‹t2ï¼Œå®ƒæŠŠé“¾æ¡ä¸­çš„å…ƒç´ å…¨éƒ¨å‡ºæ ˆï¼Œç„¶åå†ä¾æ¬¡è£…å…¥Aã€Cã€D

æ­¤æ—¶å•å‘é“¾å˜ä¸ºA->C->D

ç„¶åt1åœ¨è¿›è¡ŒCASæ—¶ï¼Œç”±äºæ ˆé¡¶è¿˜æ˜¯Aï¼Œæ‰€ä»¥compareå°±ä¼šé€šè¿‡ï¼Œå¹¶ä¸”å®Œæˆæ›¿æ¢ã€‚

æ­¤æ—¶å•å‘é“¾å˜ä¸ºï¼šB->null

ä»ç»“æœä¸Šæ¥çœ‹ï¼ŒCå’ŒDä¸¢å¤±æ‰äº†ã€‚

##### è§£å†³åŠæ³•

- åŠ æ—¶é—´æˆ³æˆ–è€…ç‰ˆæœ¬æˆ³
- AtomicStampedReference<E>ï¼ˆå†…éƒ¨ä¹Ÿæ˜¯ç‰ˆæœ¬æˆ³ï¼‰

AtomicStampedReferenceæ€ä¹ˆç”¨æš‚æ—¶è¿˜ä¸ä¼šï¼Œä»¥åå†è¯´å§ğŸ˜„

```java
public static void main(String[] args) {
    AtomicStampedReference<Integer> stampedReference = new AtomicStampedReference<>(100,1);

    //é£å¿«çš„t2
    new Thread(() -> {
        stampedReference.compareAndSet(100, 101, stampedReference.getStamp(), stampedReference.getStamp() + 1 );
        stampedReference.compareAndSet(101, 100, stampedReference.getStamp(), stampedReference.getStamp() + 1 );
    },"t2").start();

    //é¾Ÿé€Ÿçš„t1
    new Thread(() -> {
        int stamp = stampedReference.getStamp();
        try {
            Thread.sleep(3000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        boolean b = stampedReference.compareAndSet(100, 2019, stamp, stamp + 1);

    },"t1").start();

}
```

#### å¼€é”€é—®é¢˜

è‡ªæ—‹CASå¦‚æœé•¿æ—¶é—´ä¸æˆåŠŸï¼Œä¼šç»™CPUå¸¦æ¥éå¸¸å¤§çš„æ‰§è¡Œå¼€é”€ã€‚è²Œä¼¼ç›®å‰æ— è§£ï¼Œå¥½åƒä¹Ÿå¾ˆéš¾é‡åˆ°ã€‚

#### åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ

- ç”¨é”
- å¤šä¸ªå˜é‡åˆå¹¶æˆä¸€ä¸ªå˜é‡

## AotomicIntegeråŸç†

```java
public final int getAndUpdate(IntUnaryOperator updateFunction) {
    int prev, next;
    do {
        prev = get();
        next = updateFunction.applyAsInt(prev);
    } while (!compareAndSet(prev, next));
    return prev;
}

//CASæ“ä½œ
private static final sun.misc.Unsafe U = sun.misc.Unsafe.getUnsafe();
public final boolean compareAndSet(int expect, int update) {
    return U.compareAndSwapInt(this, VALUE, expect, update);
}
```

å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œä½¿ç”¨`do-while`å¯¹CASåšåˆ¤æ–­ï¼Œå¦‚æœ**CASè¿”å›falseï¼Œé‚£ä¹ˆå°±ç»§ç»­å¾ªç¯**ã€‚