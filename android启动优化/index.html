<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=zh-CN lang=zh-cn><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Android启动优化 &#183; Vee's space</title><meta name=description content><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/print.css media=print><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/poole.css><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/syntax.css><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><link href=https://vee-zhang.github.io/android%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/index.md rel=alternate type=text/plain title="Vee's space"></head><body><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://vee-zhang.github.io><h1>Vee's space</h1></a><p class=lead>关于 DoIt 主题</p></div><nav><ul class=sidebar-nav><li><a href=https://vee-zhang.github.io>Home</a></li><li><a href=/posts/>所有文章</a></li><li><a href=/tags/>标签</a></li><li><a href=/categories/>分类</a></li><li><a href=/series/>系列</a></li><li><a href=/about/>关于</a></li></ul></nav><p>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</p></div></aside><main class="content container"><div class=post><h1>Android启动优化</h1><time datetime=2021-08-03T10:27:09+0800 class=post-date>Tue, Aug 3, 2021</time><h3 id=回顾启动流程>回顾启动流程</h3><ol><li>点击App图标；</li><li>Launcher进程通过Binder向SystemServer进程发起<code>startActivity</code>请求；</li><li>SystemServer收到请求后向zygote发起<code>创建进程</code>请求；</li><li>zygote收到请求fork自己创建新的子进程（App进程）；</li><li>App进程通过binder向SystemServer进程发起<code>attachApplication</code>请求；</li><li>SystemServer收到请求后，进行一系列操作后，通过Binder向App进程发送<code>scheduleLauncherActivity</code>请求；</li><li>App进程收到请求后，通过handler向主线程发送<code>LAUNCH_ACTIVITY</code>消息；</li><li>主线程收到消息后，通过反射创建目标Activity，并调用<code>onCreate</code>方法。</li></ol><h3 id=应用启动状态>应用启动状态</h3><ul><li>冷启动：是指应用从头开始启动，系统进程在冷启动后才创建应用进程；</li><li>热启动：系统的所有工作就是将Activity带到前台，不需要重新创建、加载和绘制；</li><li>温启动： 短时间内重启应用，进程可能未被销毁，直接继续运行，但是需要重走生命周期。</li></ul><p>我们一般<strong>针对冷启动进行优化</strong>。</p><h3 id=应用启动时间>应用启动时间</h3><p>是指从点击到launcher，经过Application到第一个Activity加载渲染完毕的总时间。</p><p>所以优化的点有两个：</p><ul><li>Application的处理速度</li><li>MainActivity的加载速度</li></ul><h3 id=统计启动时间>统计启动时间</h3><ol><li><p>通过logcat中对display关键字检索，在启动后有个Displayed+包名+时间段；</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ActivityManager: Displayed com.android.myexample/.StartupTiming: +3s534ms
</span></span></code></pre></td></tr></table></div></div></li><li><p>通过adb命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>adb shell am start -S -W <span class=o>[</span>packageName<span class=o>]</span>/<span class=o>{</span>activityName<span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ThisTime: <span class=m>415</span> <span class=c1># 启动所有Activity的耗时</span>
</span></span><span class=line><span class=cl>TotalTime: <span class=m>415</span> <span class=c1># 表示冷启动的耗时，不包括前一个Activity的pause耗时</span>
</span></span><span class=line><span class=cl>WaitTime: <span class=m>437</span> <span class=c1>#总的耗时，包括前一个Activity的pause耗时和新Activity的启动耗时</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>通过Profile工具中的CPU性能剖析器。</p><ul><li>Call Chart 倒火焰图；</li><li>flame Chart 火焰图；</li><li>TopDown 详情试图。</li></ul></li><li><p>Debug-API：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nc>Debug</span><span class=p>.</span><span class=n>startMethodTracing</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nc>Debug</span><span class=p>.</span><span class=n>stopMethodTracing</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>通过配置严苛模式</p></li></ol><h3 id=黑白屏处理>黑白屏处理</h3><p>为MainActivity自定义一个style，设置背景图，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;style</span> <span class=na>name=</span><span class=s>&#34;Theme.App.NoActionBar.Launcher&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;item</span> <span class=na>name=</span><span class=s>&#34;android:windowBackground&#34;</span><span class=nt>&gt;</span>@drawable/header<span class=nt>&lt;/item&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/style&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>然后在MainActivity的<code>onCreate</code>方法中把主题再设置回去：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MainActivity</span> <span class=p>:</span> <span class=n>ComponentActivity</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setTheme</span><span class=p>(</span><span class=nc>R</span><span class=p>.</span><span class=n>style</span><span class=p>.</span><span class=n>Theme_App_NoActionBar</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>setContent</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>NewsStory</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>AsyncLayoutInflater异步加载</p></blockquote></div></main></body></html>