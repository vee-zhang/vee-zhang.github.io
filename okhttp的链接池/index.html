<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=zh-CN lang=zh-cn><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Okhttp的链接池 &#183; Vee's space</title><meta name=description content><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/print.css media=print><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/poole.css><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/syntax.css><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><link href=https://vee-zhang.github.io/okhttp%E7%9A%84%E9%93%BE%E6%8E%A5%E6%B1%A0/index.md rel=alternate type=text/plain title="Vee's space"></head><body><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://vee-zhang.github.io><h1>Vee's space</h1></a><p class=lead>关于 DoIt 主题</p></div><nav><ul class=sidebar-nav><li><a href=https://vee-zhang.github.io>Home</a></li><li><a href=/posts/>所有文章</a></li><li><a href=/tags/>标签</a></li><li><a href=/categories/>分类</a></li><li><a href=/series/>系列</a></li><li><a href=/about/>关于</a></li></ul></nav><p>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</p></div></aside><main class="content container"><div class=post><h1>Okhttp的链接池</h1><time datetime=2021-10-29T10:43:41+0800 class=post-date>Fri, Oct 29, 2021</time><p>未完待续。。。</p><p>在OkhttpClient对象中持有一个链接池<code>ConnectionPool connectionPool</code>，今天我就研究一下ok的链接复用机制。</p><h3 id=connectionpool类>ConnectionPool类</h3><p>主要用于管理和复用连接。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>ConnectionPool</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// 当然离不开线程池，核心线程数为0，最大线程数无限大，包活时间为60秒，同步队列，最后是设为守护线程？
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Executor</span> <span class=n>executor</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadPoolExecutor</span><span class=o>(</span><span class=mi>0</span> <span class=cm>/* corePoolSize */</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Integer</span><span class=o>.</span><span class=na>MAX_VALUE</span> <span class=cm>/* maximumPoolSize */</span><span class=o>,</span> <span class=mi>60L</span> <span class=cm>/* keepAliveTime */</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>,</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=n>SynchronousQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;(),</span> <span class=n>Util</span><span class=o>.</span><span class=na>threadFactory</span><span class=o>(</span><span class=s>&#34;OkHttp ConnectionPool&#34;</span><span class=o>,</span> <span class=kc>true</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 最大闲置连接数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>maxIdleConnections</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 保活时间
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>keepAliveDurationNs</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Runnable</span> <span class=n>cleanupRunnable</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span> <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>waitNanos</span> <span class=o>=</span> <span class=n>cleanup</span><span class=o>(</span><span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>waitNanos</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=o>)</span> <span class=k>return</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>waitNanos</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=kt>long</span> <span class=n>waitMillis</span> <span class=o>=</span> <span class=n>waitNanos</span> <span class=o>/</span> <span class=mi>1000000L</span><span class=o>;</span>
</span></span><span class=line><span class=cl>          <span class=n>waitNanos</span> <span class=o>-=</span> <span class=o>(</span><span class=n>waitMillis</span> <span class=o>*</span> <span class=mi>1000000L</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=kd>synchronized</span> <span class=o>(</span><span class=n>ConnectionPool</span><span class=o>.</span><span class=na>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=n>ConnectionPool</span><span class=o>.</span><span class=na>this</span><span class=o>.</span><span class=na>wait</span><span class=o>(</span><span class=n>waitMillis</span><span class=o>,</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=n>waitNanos</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>ignored</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Deque</span><span class=o>&lt;</span><span class=n>RealConnection</span><span class=o>&gt;</span> <span class=n>connections</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayDeque</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=kd>final</span> <span class=n>RouteDatabase</span> <span class=n>routeDatabase</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RouteDatabase</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=n>cleanupRunning</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Create a new connection pool with tuning parameters appropriate for a single-user application.
</span></span></span><span class=line><span class=cl><span class=cm>   * The tuning parameters in this pool are subject to change in future OkHttp releases. Currently
</span></span></span><span class=line><span class=cl><span class=cm>   * this pool holds up to 5 idle connections which will be evicted after 5 minutes of inactivity.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>ConnectionPool</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>(</span><span class=mi>5</span><span class=o>,</span> <span class=mi>5</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MINUTES</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=nf>ConnectionPool</span><span class=o>(</span><span class=kt>int</span> <span class=n>maxIdleConnections</span><span class=o>,</span> <span class=kt>long</span> <span class=n>keepAliveDuration</span><span class=o>,</span> <span class=n>TimeUnit</span> <span class=n>timeUnit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>maxIdleConnections</span> <span class=o>=</span> <span class=n>maxIdleConnections</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>keepAliveDurationNs</span> <span class=o>=</span> <span class=n>timeUnit</span><span class=o>.</span><span class=na>toNanos</span><span class=o>(</span><span class=n>keepAliveDuration</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Put a floor on the keep alive duration, otherwise cleanup will spin loop.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>keepAliveDuration</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;keepAliveDuration &lt;= 0: &#34;</span> <span class=o>+</span> <span class=n>keepAliveDuration</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 返回闲置线程数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>int</span> <span class=nf>idleConnectionCount</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>total</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>RealConnection</span> <span class=n>connection</span> <span class=o>:</span> <span class=n>connections</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>connection</span><span class=o>.</span><span class=na>allocations</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=n>total</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>total</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>int</span> <span class=nf>connectionCount</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>connections</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Returns a recycled connection to {@code address}, or null if no such connection exists. The
</span></span></span><span class=line><span class=cl><span class=cm>   * route is null if the address has not yet been routed.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Nullable</span> <span class=n>RealConnection</span> <span class=nf>get</span><span class=o>(</span><span class=n>Address</span> <span class=n>address</span><span class=o>,</span> <span class=n>StreamAllocation</span> <span class=n>streamAllocation</span><span class=o>,</span> <span class=n>Route</span> <span class=n>route</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>holdsLock</span><span class=o>(</span><span class=k>this</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>RealConnection</span> <span class=n>connection</span> <span class=o>:</span> <span class=n>connections</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>connection</span><span class=o>.</span><span class=na>isEligible</span><span class=o>(</span><span class=n>address</span><span class=o>,</span> <span class=n>route</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>streamAllocation</span><span class=o>.</span><span class=na>acquire</span><span class=o>(</span><span class=n>connection</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>connection</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Replaces the connection held by {@code streamAllocation} with a shared connection if possible.
</span></span></span><span class=line><span class=cl><span class=cm>   * This recovers when multiple multiplexed connections are created concurrently.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Nullable</span> <span class=n>Socket</span> <span class=nf>deduplicate</span><span class=o>(</span><span class=n>Address</span> <span class=n>address</span><span class=o>,</span> <span class=n>StreamAllocation</span> <span class=n>streamAllocation</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>holdsLock</span><span class=o>(</span><span class=k>this</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>RealConnection</span> <span class=n>connection</span> <span class=o>:</span> <span class=n>connections</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>connection</span><span class=o>.</span><span class=na>isEligible</span><span class=o>(</span><span class=n>address</span><span class=o>,</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>connection</span><span class=o>.</span><span class=na>isMultiplexed</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>&amp;&amp;</span> <span class=n>connection</span> <span class=o>!=</span> <span class=n>streamAllocation</span><span class=o>.</span><span class=na>connection</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>streamAllocation</span><span class=o>.</span><span class=na>releaseAndAcquire</span><span class=o>(</span><span class=n>connection</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>put</span><span class=o>(</span><span class=n>RealConnection</span> <span class=n>connection</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>holdsLock</span><span class=o>(</span><span class=k>this</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>cleanupRunning</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cleanupRunning</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>executor</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=n>cleanupRunnable</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>connections</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>connection</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Notify this pool that {@code connection} has become idle. Returns true if the connection has
</span></span></span><span class=line><span class=cl><span class=cm>   * been removed from the pool and should be closed.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kt>boolean</span> <span class=nf>connectionBecameIdle</span><span class=o>(</span><span class=n>RealConnection</span> <span class=n>connection</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>holdsLock</span><span class=o>(</span><span class=k>this</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>connection</span><span class=o>.</span><span class=na>noNewStreams</span> <span class=o>||</span> <span class=n>maxIdleConnections</span> <span class=o>==</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>connections</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>connection</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>notifyAll</span><span class=o>();</span> <span class=c1>// Awake the cleanup thread: we may have exceeded the idle connection limit.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/** Close and remove all idle connections in the pool. */</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>evictAll</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>RealConnection</span><span class=o>&gt;</span> <span class=n>evictedConnections</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=o>(</span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>RealConnection</span><span class=o>&gt;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>connections</span><span class=o>.</span><span class=na>iterator</span><span class=o>();</span> <span class=n>i</span><span class=o>.</span><span class=na>hasNext</span><span class=o>();</span> <span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>RealConnection</span> <span class=n>connection</span> <span class=o>=</span> <span class=n>i</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>connection</span><span class=o>.</span><span class=na>allocations</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>connection</span><span class=o>.</span><span class=na>noNewStreams</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>          <span class=n>evictedConnections</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>connection</span><span class=o>);</span>
</span></span><span class=line><span class=cl>          <span class=n>i</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>RealConnection</span> <span class=n>connection</span> <span class=o>:</span> <span class=n>evictedConnections</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>closeQuietly</span><span class=o>(</span><span class=n>connection</span><span class=o>.</span><span class=na>socket</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Performs maintenance on this pool, evicting the connection that has been idle the longest if
</span></span></span><span class=line><span class=cl><span class=cm>   * either it has exceeded the keep alive limit or the idle connections limit.
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * &lt;p&gt;Returns the duration in nanos to sleep until the next scheduled call to this method. Returns
</span></span></span><span class=line><span class=cl><span class=cm>   * -1 if no further cleanups are required.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=nf>cleanup</span><span class=o>(</span><span class=kt>long</span> <span class=n>now</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>inUseConnectionCount</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>idleConnectionCount</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>RealConnection</span> <span class=n>longestIdleConnection</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>longestIdleDurationNs</span> <span class=o>=</span> <span class=n>Long</span><span class=o>.</span><span class=na>MIN_VALUE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Find either a connection to evict, or the time that the next eviction is due.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=o>(</span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>RealConnection</span><span class=o>&gt;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>connections</span><span class=o>.</span><span class=na>iterator</span><span class=o>();</span> <span class=n>i</span><span class=o>.</span><span class=na>hasNext</span><span class=o>();</span> <span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>RealConnection</span> <span class=n>connection</span> <span class=o>=</span> <span class=n>i</span><span class=o>.</span><span class=na>next</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// If the connection is in use, keep searching.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>pruneAndGetAllocationCount</span><span class=o>(</span><span class=n>connection</span><span class=o>,</span> <span class=n>now</span><span class=o>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>inUseConnectionCount</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>          <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>idleConnectionCount</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// If the connection is ready to be evicted, we&#39;re done.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>long</span> <span class=n>idleDurationNs</span> <span class=o>=</span> <span class=n>now</span> <span class=o>-</span> <span class=n>connection</span><span class=o>.</span><span class=na>idleAtNanos</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>idleDurationNs</span> <span class=o>&gt;</span> <span class=n>longestIdleDurationNs</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=n>longestIdleDurationNs</span> <span class=o>=</span> <span class=n>idleDurationNs</span><span class=o>;</span>
</span></span><span class=line><span class=cl>          <span class=n>longestIdleConnection</span> <span class=o>=</span> <span class=n>connection</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>longestIdleDurationNs</span> <span class=o>&gt;=</span> <span class=k>this</span><span class=o>.</span><span class=na>keepAliveDurationNs</span>
</span></span><span class=line><span class=cl>          <span class=o>||</span> <span class=n>idleConnectionCount</span> <span class=o>&gt;</span> <span class=k>this</span><span class=o>.</span><span class=na>maxIdleConnections</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// We&#39;ve found a connection to evict. Remove it from the list, then close it below (outside
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// of the synchronized block).
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>connections</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>longestIdleConnection</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>idleConnectionCount</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// A connection will be ready to evict soon.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>keepAliveDurationNs</span> <span class=o>-</span> <span class=n>longestIdleDurationNs</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>inUseConnectionCount</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// All connections are in use. It&#39;ll be at least the keep alive duration &#39;til we run again.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>keepAliveDurationNs</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// No connections, idle or in use.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>cleanupRunning</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>closeQuietly</span><span class=o>(</span><span class=n>longestIdleConnection</span><span class=o>.</span><span class=na>socket</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Cleanup again immediately.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Prunes any leaked allocations and then returns the number of remaining live allocations on
</span></span></span><span class=line><span class=cl><span class=cm>   * {@code connection}. Allocations are leaked if the connection is tracking them but the
</span></span></span><span class=line><span class=cl><span class=cm>   * application code has abandoned them. Leak detection is imprecise and relies on garbage
</span></span></span><span class=line><span class=cl><span class=cm>   * collection.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>private</span> <span class=kt>int</span> <span class=nf>pruneAndGetAllocationCount</span><span class=o>(</span><span class=n>RealConnection</span> <span class=n>connection</span><span class=o>,</span> <span class=kt>long</span> <span class=n>now</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Reference</span><span class=o>&lt;</span><span class=n>StreamAllocation</span><span class=o>&gt;&gt;</span> <span class=n>references</span> <span class=o>=</span> <span class=n>connection</span><span class=o>.</span><span class=na>allocations</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>references</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Reference</span><span class=o>&lt;</span><span class=n>StreamAllocation</span><span class=o>&gt;</span> <span class=n>reference</span> <span class=o>=</span> <span class=n>references</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>(</span><span class=n>reference</span><span class=o>.</span><span class=na>get</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span><span class=o>++;</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// We&#39;ve discovered a leaked allocation. This is an application bug.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>StreamAllocation</span><span class=o>.</span><span class=na>StreamAllocationReference</span> <span class=n>streamAllocRef</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=o>(</span><span class=n>StreamAllocation</span><span class=o>.</span><span class=na>StreamAllocationReference</span><span class=o>)</span> <span class=n>reference</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>String</span> <span class=n>message</span> <span class=o>=</span> <span class=s>&#34;A connection to &#34;</span> <span class=o>+</span> <span class=n>connection</span><span class=o>.</span><span class=na>route</span><span class=o>().</span><span class=na>address</span><span class=o>().</span><span class=na>url</span><span class=o>()</span>
</span></span><span class=line><span class=cl>          <span class=o>+</span> <span class=s>&#34; was leaked. Did you forget to close a response body?&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=n>Platform</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>logCloseableLeak</span><span class=o>(</span><span class=n>message</span><span class=o>,</span> <span class=n>streamAllocRef</span><span class=o>.</span><span class=na>callStackTrace</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>references</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>connection</span><span class=o>.</span><span class=na>noNewStreams</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// If this was the last allocation, the connection is eligible for immediate eviction.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=o>(</span><span class=n>references</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>connection</span><span class=o>.</span><span class=na>idleAtNanos</span> <span class=o>=</span> <span class=n>now</span> <span class=o>-</span> <span class=n>keepAliveDurationNs</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>references</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></div></main></body></html>