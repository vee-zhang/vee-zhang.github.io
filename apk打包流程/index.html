<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=zh-CN lang=zh-cn><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Apk打包和安装流程 &#183; Vee's space</title><meta name=description content><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/print.css media=print><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/poole.css><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/syntax.css><link type=text/css rel=stylesheet href=https://vee-zhang.github.iocss/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><link href=https://vee-zhang.github.io/apk%E6%89%93%E5%8C%85%E6%B5%81%E7%A8%8B/index.md rel=alternate type=text/plain title="Vee's space"></head><body><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://vee-zhang.github.io><h1>Vee's space</h1></a><p class=lead>关于 DoIt 主题</p></div><nav><ul class=sidebar-nav><li><a href=https://vee-zhang.github.io>Home</a></li><li><a href=/posts/>所有文章</a></li><li><a href=/tags/>标签</a></li><li><a href=/categories/>分类</a></li><li><a href=/series/>系列</a></li><li><a href=/about/>关于</a></li></ul></nav><p>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</p></div></aside><main class="content container"><div class=post><h1>Apk打包和安装流程</h1><time datetime=2021-06-21T17:49:10Z class=post-date>Mon, Jun 21, 2021</time><h2 id=apk文件的组成>.apk文件的组成</h2><p>apk文件其实就是个压缩包，里面包含：</p><ul><li>classes.dex编译后的代码文件，安卓的可执行文件</li><li>resource.arsc 编译后的资源文件（raw）</li><li>AndroidManifest.xml 应用配置文件</li><li>res文件夹 未编译的应用资源</li><li>META-info文件夹 签名，包信息等</li></ul><h2 id=打包流程>打包流程</h2><ol><li>aapt编译打包资源文件，生成<code>R.java</code>。<ol><li>编译AndroidManifest成二进制；</li><li>编译layout等xml文件，生成<code>R.java</code>，和<code>resource.arsc</code>文件。</li></ol></li><li>处理aidl文件，生成对应的.java文件。</li><li>java编译器（javac）编译项目源码，生成.class文件，位于bin/classes目录下；</li><li>Android编译器使用dx工具整合所有的class文件生成<code>classes.dex</code>文件；</li><li>由<code>apkbuilder</code>打包生成apk；</li><li>对包签名；</li><li>对齐处理，将包中的资源文件距离文件起始偏移为4字节的整数倍，这样通过内存映射访问apk文件时可提高速度，减少运行时内存的使用。</li></ol><h2 id=安装流程>安装流程</h2><p>核心类：<code>PMS</code>(PackageManagerService)</p><ol><li>复制apk到<code>data/app</code>目录下，解压并扫描安装包，把classes.dex文件保存到dalvik-cache目录，并再data/data目录下创建对应的应用数据目录；</li><li>解析AndroidManifinest，提取信息写入<code>/data/system/packages.xml</code>；</li><li>Launcher加载桌面图标；</li></ol><h2 id=apk安装方式>APK安装方式</h2><table><thead><tr><th>方式</th><th>有无界面</th></tr></thead><tbody><tr><td>系统应用</td><td>无</td></tr><tr><td>market应用下载</td><td>无</td></tr><tr><td>第三方下载</td><td>有</td></tr><tr><td>adb</td><td>无</td></tr></tbody></table><h2 id=反编译>反编译</h2><h3 id=流程>流程</h3><ol><li>解压.apk</li><li>使用dex2jar将class.dex转为jar包</li><li>使用jd-gui反编译jar包</li></ol><h3 id=加固手段>加固手段</h3><ul><li>反模拟器
模拟器运行apk，可以监控到各种行为，所以发现时模拟器在运行就直接退出。</li><li>代码虚拟化
自建一个虚拟执行引擎，然后把原生的可执行代码转换成自定义的指令进行虚拟执行。</li><li>加密
样本的部分可执行代码是以压缩或者加密的形式存在的，比如被保护过的代码被切割成多个小段，前面的一段代码先把后面的代码片段在内存中解密，然后再执行解密之后的代码。</li></ul><h3 id=dex文件结构>dex文件结构</h3><p><img src=dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.png alt=dex文件结构></p></div></main></body></html>